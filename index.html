<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Meticulous">
<meta name="theme-color" content="#1F1F1F">
<title>Meticulous — Priority Board</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --beige: #EDEDEB;
    --soft-gray: #D9D9D9;
    --red: #F0380F;
    --black: #1F1F1F;
    --white: #FFFFFF;
    --mid: #8A8A88;
    --divider: #D0D0CE;
    --border-radius: 0px;
  }

  * { box-sizing:border-box; margin:0; padding:0; }

  body {
    background:var(--beige);
    font-family:'Noto Sans',sans-serif;
    color:var(--black);
    height:100vh;
    height:100dvh;
    overflow:hidden;
    line-height:1.6;
  }

  /* ── SCROLLBARS ── */
  ::-webkit-scrollbar { width:3px; height:3px; }
  ::-webkit-scrollbar-track { background:transparent; }
  ::-webkit-scrollbar-thumb { background:var(--soft-gray); }

  /* ── TYPOGRAPHY ── */
  h1,h2,h3,h4 {
    font-family:'Noto Sans',sans-serif;
    font-weight:700;
    letter-spacing:-0.02em;
  }

  /* ── HEADER ── */
  header {
    height:52px;
    padding:0 24px;
    display:flex;
    align-items:center;
    gap:0;
    border-bottom:1px solid var(--black);
    flex-shrink:0;
    background:var(--black);
  }

  .hdr-brand {
    display:flex;
    align-items:center;
    gap:0;
  }

  .hdr-isotype {
    background:var(--red);
    color:var(--white);
    width:52px;
    height:52px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:700;
    font-size:13px;
    letter-spacing:0.05em;
    flex-shrink:0;
    margin-left:-24px;
  }

  .hdr-wordmark {
    font-family:'Noto Sans',sans-serif;
    font-size:13px;
    font-weight:700;
    color:var(--white);
    letter-spacing:0.12em;
    text-transform:uppercase;
    padding-left:16px;
  }

  .hdr-subtitle {
    font-size:11px;
    font-weight:400;
    color:rgba(255,255,255,0.35);
    letter-spacing:0.1em;
    text-transform:uppercase;
    padding-left:20px;
    border-left:1px solid rgba(255,255,255,0.15);
    margin-left:16px;
  }

  .hdr-right {
    margin-left:auto;
    display:flex;
    align-items:center;
    gap:0;
  }

  .today {
    font-size:10px;
    font-weight:400;
    color:rgba(255,255,255,0.3);
    letter-spacing:0.08em;
    text-transform:uppercase;
    margin-right:16px;
  }

  .btn {
    border:none;
    padding:0 16px;
    height:32px;
    font-family:'Noto Sans',sans-serif;
    font-size:10px;
    font-weight:600;
    letter-spacing:0.1em;
    text-transform:uppercase;
    cursor:pointer;
    transition:all 0.15s;
    border-radius:var(--border-radius);
  }
  .btn-primary {
    background:var(--red);
    color:var(--white);
  }
  .btn-primary:hover { opacity:0.85; }
  .btn-secondary {
    background:rgba(255,255,255,0.08);
    color:rgba(255,255,255,0.6);
    border:1px solid rgba(255,255,255,0.15);
    margin-right:6px;
  }
  .btn-secondary:hover { background:rgba(255,255,255,0.14); color:var(--white); }

  /* ── LAYOUT ── */
  .app { display:flex; height:calc(100vh - 52px); }

  /* ── PANE BASE ── */
  .pane {
    display:flex;
    flex-direction:column;
    flex-shrink:0;
    border-right:1px solid var(--divider);
    overflow:hidden;
  }
  .pane-header {
    padding:0 16px;
    height:40px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    border-bottom:1px solid var(--divider);
    flex-shrink:0;
    background:var(--white);
  }
  .pane-title {
    font-size:9px;
    font-weight:700;
    letter-spacing:0.14em;
    text-transform:uppercase;
    color:var(--mid);
  }
  .pane-body { flex:1; overflow-y:auto; overflow-x:hidden; }

  /* ── PILLARS PANE ── */
  #pane-pillars { width:220px; background:var(--beige); }
  #pane-pillars .pane-body { padding:8px; display:flex; flex-direction:column; gap:2px; }

  .pillar-row {
    padding:10px 12px;
    cursor:pointer;
    transition:background 0.1s;
    border:1px solid transparent;
    position:relative;
    border-radius:var(--border-radius);
  }
  .pillar-row:hover { background:var(--white); }
  .pillar-row.sel {
    background:var(--black) !important;
    border-color:var(--black);
  }
  .pillar-row.sel .pr-name { color:var(--white); }
  .pillar-row.sel .pr-desc { color:rgba(255,255,255,0.5); }
  .pillar-row.sel .pr-count { color:var(--white); }
  .pillar-row.sel .pr-bar { background:rgba(255,255,255,0.15); }
  .pillar-row.sel .pr-bar-fill { background:var(--red); }

  .pr-top { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:3px; }
  .pr-icon { font-size:13px; line-height:1; }
  .pr-count { font-size:18px; font-weight:700; line-height:1; color:var(--black); letter-spacing:-0.02em; }
  .pr-name { font-size:11px; font-weight:700; line-height:1.3; color:var(--black); text-transform:uppercase; letter-spacing:0.04em; }
  .pr-desc { font-size:10px; font-weight:400; color:var(--mid); line-height:1.45; margin-top:3px; }
  .pr-bar { margin-top:8px; height:2px; background:var(--soft-gray); overflow:hidden; }
  .pr-bar-fill { height:100%; background:var(--black); transition:width 0.3s; }
  .pr-edit {
    position:absolute; top:8px; right:8px;
    background:none; border:1px solid var(--divider);
    color:var(--mid); font-size:9px; cursor:pointer;
    padding:2px 6px; opacity:0; transition:opacity 0.12s;
    font-family:'Noto Sans',sans-serif; font-weight:600;
    letter-spacing:0.05em; text-transform:uppercase;
    border-radius:var(--border-radius);
  }
  .pillar-row:hover .pr-edit { opacity:1; }
  .pillar-row.sel .pr-edit { border-color:rgba(255,255,255,0.2); color:rgba(255,255,255,0.5); }
  .pr-edit:hover { background:var(--soft-gray); }
  .pillar-row.sel .pr-edit:hover { background:rgba(255,255,255,0.1); color:var(--white); }

  /* ── FUNCTIONS PANE ── */
  #pane-functions { width:186px; background:var(--beige); }
  #pane-functions .pane-body { padding:0; }

  .fn-row {
    display:flex;
    align-items:center;
    gap:10px;
    padding:9px 16px;
    cursor:pointer;
    border-left:2px solid transparent;
    border-bottom:1px solid var(--divider);
    transition:all 0.1s;
    position:relative;
  }
  .fn-row:last-child { border-bottom:none; }
  .fn-row.fn-dragging { opacity:0.25; }
  .fn-row.fn-drag-over { border-top:2px solid var(--red); padding-top:7px; }
  .fn-row:hover { background:var(--white); }
  .fn-row.sel { background:var(--white); border-left-color:var(--red); }
  .fn-dot { width:6px; height:6px; flex-shrink:0; border-radius:var(--border-radius); }
  .fn-label { font-size:11px; font-weight:500; color:var(--mid); flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .fn-row.sel .fn-label { color:var(--black); font-weight:600; }
  .fn-row:hover .fn-label { color:var(--black); }
  .fn-badge {
    font-size:9px; font-weight:700;
    padding:1px 5px;
    background:var(--soft-gray);
    color:var(--mid);
    flex-shrink:0;
    border-radius:var(--border-radius);
    letter-spacing:0.04em;
  }
  .fn-row.sel .fn-badge { background:var(--red); color:var(--white); }

  /* responsibilities tooltip */
  .fn-tooltip {
    display:none; position:absolute; left:calc(100% + 1px); top:-1px; z-index:100;
    width:260px;
    background:var(--black);
    border:1px solid var(--black);
    padding:14px 16px;
    box-shadow:4px 4px 0px rgba(0,0,0,0.15);
    pointer-events:none;
  }
  .fn-row:hover .fn-tooltip { display:block; }
  .fn-tooltip-title {
    font-size:9px; font-weight:700; letter-spacing:0.14em;
    text-transform:uppercase; color:var(--red); margin-bottom:10px;
  }
  .fn-tooltip ul { list-style:none; display:flex; flex-direction:column; gap:5px; }
  .fn-tooltip li {
    font-size:11px; color:rgba(255,255,255,0.6); line-height:1.5;
    padding-left:12px; position:relative;
  }
  .fn-tooltip li::before { content:'—'; position:absolute; left:0; color:var(--red); font-size:9px; top:2px; }

  /* ── KANBAN AREA ── */
  .kanban-area { flex:1; display:flex; flex-direction:column; overflow:hidden; min-width:0; }

  /* active filter bar */
  .active-filter-bar {
    padding:0 16px; height:36px;
    display:flex; align-items:center; gap:8px;
    border-bottom:1px solid var(--divider);
    flex-shrink:0; background:var(--white);
  }
  .active-filter-label {
    font-size:9px; font-weight:700; letter-spacing:0.12em;
    text-transform:uppercase; color:var(--mid);
  }
  .active-filter-chip {
    display:flex; align-items:center; gap:5px;
    font-size:10px; font-weight:600; padding:2px 8px;
    border:1px solid var(--black); cursor:pointer;
    transition:all 0.1s; background:var(--black); color:var(--white);
    text-transform:uppercase; letter-spacing:0.06em;
    border-radius:var(--border-radius);
  }
  .active-filter-chip:hover { background:var(--red); border-color:var(--red); }
  .chip-clear { font-size:12px; opacity:0.7; margin-left:1px; }
  .clear-all-btn {
    margin-left:auto; background:none; border:none;
    font-size:9px; font-weight:700; letter-spacing:0.1em; text-transform:uppercase;
    color:var(--mid); cursor:pointer; font-family:'Noto Sans',sans-serif;
  }
  .clear-all-btn:hover { color:var(--red); }

  /* sub-filter bar */
  .sub-filter-bar {
    padding:0 16px; height:36px;
    display:flex; gap:0; align-items:center;
    border-bottom:1px solid var(--divider);
    flex-shrink:0; background:var(--beige);
  }
  .filter-label {
    font-size:9px; font-weight:700; letter-spacing:0.12em;
    text-transform:uppercase; color:var(--mid); margin-right:8px;
  }
  .filter-sep { width:1px; height:20px; background:var(--divider); margin:0 10px; }
  .pill {
    padding:0 10px; height:22px; line-height:22px;
    font-family:'Noto Sans',sans-serif; font-size:9px; font-weight:600;
    letter-spacing:0.08em; text-transform:uppercase;
    cursor:pointer; border:1px solid transparent;
    color:var(--mid); background:none;
    transition:all 0.1s; border-radius:var(--border-radius);
    margin-right:2px;
  }
  .pill:hover { background:var(--white); color:var(--black); border-color:var(--divider); }
  .pill.active { background:var(--black); color:var(--white); border-color:var(--black); }

  /* ── BOARD ── */
  .board { display:grid; grid-template-columns:repeat(4,1fr); flex:1; overflow-x:auto; overflow-y:hidden; }
  .column { display:flex; flex-direction:column; border-right:1px solid var(--divider); overflow:hidden; }
  .column:last-child { border-right:none; }
  .column.col-dragging { opacity:0.3; }
  .column.col-drag-over { border-left:2px solid var(--red); }

  .col-header {
    padding:0 14px; height:40px;
    display:flex; align-items:center; gap:8px;
    border-bottom:1px solid var(--divider);
    flex-shrink:0; background:var(--white);
  }
  .kdot { width:6px; height:6px; flex-shrink:0; border-radius:var(--border-radius); }
  .col-header h2 {
    font-size:9px; font-weight:700; letter-spacing:0.14em;
    text-transform:uppercase; color:var(--mid);
  }
  .col-count {
    margin-left:auto; font-size:9px; font-weight:700;
    color:var(--mid); background:var(--soft-gray);
    padding:1px 6px; letter-spacing:0.04em;
    border-radius:var(--border-radius);
  }

  /* column colors applied via inline styles in renderKanban() */

  .cards-container {
    flex:1; overflow-y:auto;
    padding:8px; display:flex; flex-direction:column; gap:6px;
    background:var(--beige);
  }
  .cards-container.drag-over { background:#E8E8E6; }
  .drop-indicator { height:2px; background:var(--red); margin:2px 0; flex-shrink:0; }

  /* ── KANBAN CARD ── */
  .card {
    background:var(--white);
    padding:10px 12px;
    cursor:grab;
    transition:box-shadow 0.12s, opacity 0.15s;
    border:1px solid var(--divider);
    user-select:none;
    border-radius:var(--border-radius);
  }
  .card:hover { box-shadow:3px 3px 0 var(--black); border-color:var(--black); }
  .card.dragging { opacity:0.25; cursor:grabbing; }

  .card-top { display:flex; align-items:center; gap:4px; margin-bottom:6px; flex-wrap:wrap; }
  .card-fn-badge {
    font-size:8px; font-weight:700; letter-spacing:0.08em;
    text-transform:uppercase; padding:2px 5px;
    border-radius:var(--border-radius);
  }
  .card-pillar-stripe {
    width:4px; height:14px; flex-shrink:0; margin-left:2px;
    border-radius:var(--border-radius);
  }
  .card-owner-av {
    margin-left:auto; width:20px; height:20px; flex-shrink:0;
    display:flex; align-items:center; justify-content:center;
    font-size:8px; font-weight:700; color:white;
    border-radius:var(--border-radius);
  }
  .card-title { font-size:12px; font-weight:600; color:var(--black); line-height:1.4; margin-bottom:3px; }
  .card-note { font-size:10.5px; font-weight:400; color:var(--mid); line-height:1.45; white-space:pre-line; }
  .card-footer {
    display:flex; align-items:center; justify-content:space-between;
    margin-top:8px; padding-top:6px; border-top:1px solid var(--divider);
  }
  .card-link { font-size:9px; font-weight:600; color:var(--black); text-decoration:none; letter-spacing:0.04em; }
  .card-link:hover { color:var(--red); }
  .card-pri { display:flex; gap:3px; align-items:center; flex-shrink:0; }
  .pri-dot { width:6px; height:6px; border:1px solid var(--soft-gray); background:transparent; border-radius:50%; }
  .pri-dot.filled { background:var(--red); border-color:var(--red); }

  .card-due {
    font-size:9px; font-weight:600; letter-spacing:0.04em;
    color:var(--mid); display:flex; align-items:center; gap:3px;
  }
  .card-due.due-overdue { color:#C62828; }
  .card-due.due-soon { color:#E65100; }
  .card-due.due-ok { color:var(--mid); }
  .card.card-overdue { border-left:3px solid #C62828; }
  .card.card-due-soon { border-left:3px solid #E65100; }

  .card-next-action {
    font-size:11px; font-weight:600; color:var(--black); line-height:1.4;
    margin-bottom:3px; padding:3px 6px; background:#FFF8E1; border-left:2px solid #F9A825;
  }
  .card-age { font-size:9px; font-weight:600; letter-spacing:0.04em; display:flex; align-items:center; gap:3px; }
  .age-fresh  { color:#2E7D32; }
  .age-normal { color:var(--mid); }
  .age-stale  { color:#E65100; }
  .age-stuck  { color:#C62828; }

  .compact .card-note { display:none; }
  .compact .card { padding:6px 10px; }
  .compact .card-title { margin-bottom:0; font-size:11px; }

  .empty-col {
    text-align:center; padding:24px 10px;
    font-size:9px; font-weight:700; letter-spacing:0.12em;
    text-transform:uppercase; color:var(--soft-gray);
  }

  /* ── FUNCTION COLOR MAP ── */
  .fn-finops       { background:#F5F0DC; color:#5C4A00; } .dot-finops       { background:#B8A050; }
  .fn-marketing    { background:#FFE8EC; color:#7A1535; } .dot-marketing    { background:var(--red); }
  .fn-operations   { background:#E8EEF8; color:#1A3352; } .dot-operations   { background:#1565C0; }
  .fn-product      { background:#E8F4E8; color:#1B4A1E; } .dot-product      { background:#2E7D32; }
  .fn-supplychain  { background:#FFF0E8; color:#6B2A00; } .dot-supplychain  { background:#E65100; }
  .fn-manufacturing{ background:#EEE8F8; color:#2E1A52; } .dot-manufacturing{ background:#6A1B9A; }
  .fn-quality      { background:#F8F4E4; color:#4A3800; } .dot-quality      { background:#F9A825; }
  .fn-fulfillment  { background:#E4F8F4; color:#004A3A; } .dot-fulfillment  { background:#00695C; }
  .fn-website      { background:#F0F8E4; color:#3A4A00; } .dot-website      { background:#558B2F; }
  .fn-software     { background:#E4F8F8; color:#004A4A; } .dot-software     { background:#00838F; }
  .fn-support      { background:#FFF0E8; color:#4A2000; } .dot-support      { background:#BF360C; }
  .fn-roast        { background:#F0E8F8; color:#2A004A; } .dot-roast        { background:#6A1B9A; }
  .fn-ip           { background:#EEE8F8; color:#3D1A5C; } .dot-ip           { background:#9C27B0; }
  .fn-accounting   { background:#E8F8E8; color:#004A00; } .dot-accounting   { background:#2E7D32; }
  .fn-legal        { background:#F8E8E8; color:#4A0000; } .dot-legal        { background:#C62828; }

  /* ── AI WORKSPACE ── */
  .ai-workspace { display:none; position:fixed; inset:0; z-index:300; background:var(--white); flex-direction:column; }
  .ai-workspace.open { display:flex; }

  .ai-topbar { height:52px; padding:0 24px; display:flex; align-items:center; gap:16px;
    border-bottom:1px solid var(--divider); flex-shrink:0; background:var(--white); }
  .ai-back { background:none; border:1px solid var(--divider); cursor:pointer; padding:6px 14px;
    font-family:'Noto Sans',sans-serif; font-size:10px; font-weight:600;
    letter-spacing:0.08em; text-transform:uppercase; color:var(--mid); }
  .ai-back:hover { border-color:var(--black); color:var(--black); }
  .ai-topbar-title { font-size:14px; font-weight:700; flex:1; }

  .ai-body { display:flex; flex:1; overflow:hidden; }

  .ai-context { width:280px; border-right:1px solid var(--divider); overflow-y:auto; padding:20px;
    font-size:11px; flex-shrink:0; background:var(--beige); }
  .ai-ctx-section { margin-bottom:16px; }
  .ai-ctx-label { font-size:9px; font-weight:700; letter-spacing:0.12em; text-transform:uppercase;
    color:var(--mid); margin-bottom:4px; }
  .ai-ctx-value { font-size:12px; font-weight:500; color:var(--black); line-height:1.5; }
  .ai-ctx-brief { font-size:11px; color:var(--black); line-height:1.6; white-space:pre-wrap; }

  .ai-chat { flex:1; display:flex; flex-direction:column; overflow:hidden; }
  .ai-messages { flex:1; overflow-y:auto; padding:24px; display:flex; flex-direction:column; gap:20px; }

  .ai-msg { max-width:90%; line-height:1.6; }
  .ai-msg-user { align-self:flex-end; background:var(--black); color:var(--white); padding:12px 16px;
    font-size:13px; white-space:pre-wrap; }
  .ai-msg-ai { align-self:flex-start; background:var(--beige); padding:16px 20px;
    font-size:13px; }
  .ai-msg-ai h1,.ai-msg-ai h2,.ai-msg-ai h3 { margin:12px 0 6px; font-size:14px; }
  .ai-msg-ai h1 { font-size:16px; }
  .ai-msg-ai h2 { font-size:15px; }
  .ai-msg-ai code { background:var(--soft-gray); padding:1px 4px; font-size:12px; }
  .ai-msg-ai pre { background:var(--soft-gray); padding:12px; overflow-x:auto; margin:8px 0; font-size:12px; line-height:1.5; }
  .ai-msg-ai pre code { background:none; padding:0; }
  .ai-msg-ai p { margin:8px 0; }
  .ai-msg-ai ul,.ai-msg-ai ol { margin:8px 0; padding-left:20px; }
  .ai-msg-ai li { margin:4px 0; }
  .ai-msg-ai strong { font-weight:700; }
  .ai-msg-ai blockquote { border-left:3px solid var(--divider); padding-left:12px; color:var(--mid); margin:8px 0; }
  .ai-msg-streaming { white-space:pre-wrap; }
  .ai-msg-streaming::after { content:'▊'; animation:blink 0.8s infinite; }
  @keyframes blink { 50% { opacity:0; } }

  .ai-msg-error { align-self:flex-start; background:#FFF0F0; color:#C62828; padding:12px 16px;
    font-size:12px; border-left:3px solid #C62828; }

  .ai-input-bar { padding:16px 24px; border-top:1px solid var(--divider); display:flex; gap:10px; }
  .ai-input { flex:1; padding:12px 14px; border:1px solid var(--divider); font-family:'Noto Sans',sans-serif;
    font-size:13px; resize:none; min-height:44px; max-height:120px; outline:none; background:var(--beige); }
  .ai-input:focus { border-color:var(--black); background:var(--white); }
  .ai-send { background:var(--black); color:var(--white); border:none; padding:0 20px; cursor:pointer;
    font-family:'Noto Sans',sans-serif; font-size:10px; font-weight:700;
    letter-spacing:0.1em; text-transform:uppercase; }
  .ai-send:hover { background:var(--red); }
  .ai-send:disabled { opacity:0.3; cursor:default; }

  /* ── MODALS ── */
  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:200; align-items:center; justify-content:center; }
  .modal-overlay.open { display:flex; }
  .modal {
    background:var(--white); padding:28px; width:480px; max-height:88vh;
    overflow-y:auto; box-shadow:6px 6px 0 var(--black); border:1px solid var(--black);
    border-radius:var(--border-radius);
  }
  .modal h3 { font-size:18px; font-weight:700; margin-bottom:20px; color:var(--black); letter-spacing:-0.02em; }
  .form-row { margin-top:14px; }
  .form-row label {
    display:block; font-size:9px; font-weight:700; letter-spacing:0.12em;
    text-transform:uppercase; color:var(--mid); margin-bottom:5px;
  }
  .modal input,.modal select,.modal textarea {
    width:100%; padding:8px 10px; border:1px solid var(--divider);
    font-family:'Noto Sans',sans-serif; font-size:13px; color:var(--black);
    background:var(--beige); outline:none; border-radius:var(--border-radius);
  }
  .modal input:focus,.modal select:focus,.modal textarea:focus { border-color:var(--black); background:var(--white); }
  .modal textarea { resize:vertical; min-height:60px; }
  .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:20px; padding-top:16px; border-top:1px solid var(--divider); }
  .btn-cancel {
    background:none; border:1px solid var(--divider); padding:8px 16px;
    cursor:pointer; font-family:'Noto Sans',sans-serif; font-size:11px;
    font-weight:600; letter-spacing:0.08em; text-transform:uppercase; color:var(--mid);
    border-radius:var(--border-radius);
  }
  .btn-cancel:hover { border-color:var(--black); color:var(--black); }
  .btn-save {
    background:var(--black); color:var(--white); border:none;
    padding:8px 18px; cursor:pointer; font-family:'Noto Sans',sans-serif;
    font-size:11px; font-weight:700; letter-spacing:0.1em; text-transform:uppercase;
    transition:background 0.15s; border-radius:var(--border-radius);
  }
  .btn-save:hover { background:var(--red); }
  .delete-link {
    font-size:9px; font-weight:700; letter-spacing:0.1em; text-transform:uppercase;
    color:#C62828; cursor:pointer; border:none; background:none;
    font-family:'Noto Sans',sans-serif;
  }
  .delete-link:hover { color:var(--red); }
  .btn-brief {
    font-size:9px; font-weight:700; letter-spacing:0.1em; text-transform:uppercase;
    color:var(--mid); cursor:pointer; border:1px solid var(--divider); background:none;
    font-family:'Noto Sans',sans-serif; padding:6px 12px;
    border-radius:var(--border-radius); transition:all 0.15s;
  }
  .btn-brief:hover { border-color:var(--black); color:var(--black); }
  .btn-brief:disabled { opacity:0.5; cursor:default; }
  .two-col { display:grid; grid-template-columns:1fr 1fr; gap:12px; }

  /* emoji + color pickers */
  .emoji-options { display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
  .emoji-opt { font-size:18px; cursor:pointer; padding:4px 6px; border:1px solid var(--divider); transition:all 0.1s; border-radius:var(--border-radius); }
  .emoji-opt:hover,.emoji-opt.selected { border-color:var(--black); background:var(--beige); }
  .color-options { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
  .color-opt { width:22px; height:22px; cursor:pointer; border:2px solid transparent; transition:all 0.1s; border-radius:var(--border-radius); }
  .color-opt:hover,.color-opt.selected { border-color:var(--black); transform:scale(1.1); }

  /* owner modal list items */
  .owner-item {
    display:flex; align-items:center; gap:10px;
    padding:8px 0; border-bottom:1px solid var(--divider);
  }
  .owner-av-lg {
    width:28px; height:28px;
    display:flex; align-items:center; justify-content:center;
    font-size:10px; font-weight:700; color:white;
    border-radius:var(--border-radius); flex-shrink:0;
  }

  /* ── MOBILE: bottom nav (hidden on desktop) ── */
  .mobile-bottom-nav { display:none; }
  .mobile-overflow-btn { display:none; }
  .mobile-overflow-menu { display:none; }
  .mobile-action-sheet { display:none; }

  /* ══════════════════════════════════════════
     MOBILE RESPONSIVE — iPhone Safari
     ══════════════════════════════════════════ */
  @media (max-width: 768px) {

    body { overscroll-behavior:none; }

    /* ── HEADER ── */
    header {
      height:48px;
      padding:0 12px;
      padding-top:env(safe-area-inset-top);
    }
    .hdr-isotype {
      width:48px; height:48px; font-size:12px;
      margin-left:-12px;
    }
    .hdr-wordmark { display:none; }
    .hdr-subtitle { display:none; }
    .today { display:none; }
    #save-status { display:none; }

    .hdr-right { gap:6px; }
    .hdr-right .btn-secondary { display:none; }
    .hdr-right .btn-primary { display:none; }

    /* Show only + Card button on mobile (re-show it) */
    .hdr-right .btn-secondary[onclick*="openCardModal"] { display:inline-flex; padding:0 12px; height:32px; font-size:9px; }

    /* Mobile overflow button */
    .mobile-overflow-btn {
      display:inline-flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15);
      color:rgba(255,255,255,0.6); width:32px; height:32px; cursor:pointer;
      font-size:16px; font-weight:700; border-radius:var(--border-radius);
    }
    .mobile-overflow-btn:hover { background:rgba(255,255,255,0.14); color:var(--white); }

    /* Overflow dropdown */
    .mobile-overflow-menu {
      display:none; position:absolute; top:100%; right:12px;
      background:var(--black); border:1px solid rgba(255,255,255,0.15);
      z-index:150; min-width:160px;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
    }
    .mobile-overflow-menu.open { display:flex; flex-direction:column; }
    .mobile-overflow-menu button {
      background:none; border:none; border-bottom:1px solid rgba(255,255,255,0.1);
      color:rgba(255,255,255,0.7); padding:14px 16px; text-align:left;
      font-family:'Noto Sans',sans-serif; font-size:12px; font-weight:500;
      cursor:pointer;
    }
    .mobile-overflow-menu button:last-child { border-bottom:none; }
    .mobile-overflow-menu button:hover { background:rgba(255,255,255,0.08); color:var(--white); }

    /* ── LAYOUT ── */
    .app {
      height:calc(100vh - 48px - 52px);
      height:calc(100dvh - 48px - 52px - env(safe-area-inset-top));
      flex-direction:column;
    }

    /* ── SIDEBARS → full-screen overlays ── */
    #pane-pillars, #pane-functions {
      display:none;
      position:fixed;
      top:48px;
      top:calc(48px + env(safe-area-inset-top));
      left:0; right:0;
      bottom:52px;
      bottom:calc(52px + env(safe-area-inset-bottom));
      width:100% !important;
      z-index:100;
      border-right:none;
    }
    #pane-pillars.mobile-open, #pane-functions.mobile-open {
      display:flex;
    }

    /* ── KANBAN → horizontal scroll-snap ── */
    .kanban-area {
      flex:1; min-width:0; min-height:0; overflow:hidden;
    }
    .board {
      display:flex !important;
      grid-template-columns:unset !important;
      overflow-x:auto;
      overflow-y:hidden;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
      flex:1;
    }
    .column {
      min-width:100%;
      max-width:100%;
      scroll-snap-align:start;
      flex-shrink:0;
      border-right:none;
    }

    /* ── FILTER BAR ── */
    .sub-filter-bar {
      flex-wrap:wrap;
      height:auto;
      padding:8px 12px;
      gap:4px;
    }
    .filter-sep { display:none; }
    .filter-label {
      width:100%;
      margin-bottom:2px;
      margin-right:0;
    }
    .filter-label:first-child { margin-top:0; }
    .pill {
      height:32px; line-height:32px;
      padding:0 12px;
      font-size:10px;
    }
    #hide-done-cb, #compact-cb { width:18px; height:18px; }

    /* Active filter bar */
    .active-filter-bar {
      padding:6px 12px;
      height:auto;
      flex-wrap:wrap;
      gap:6px;
    }
    .active-filter-chip {
      font-size:11px;
      padding:4px 10px;
    }

    /* ── MODALS → bottom sheet ── */
    .modal-overlay {
      align-items:flex-end !important;
      justify-content:center !important;
    }
    .modal {
      width:100% !important;
      max-width:100%;
      max-height:85vh;
      border:none;
      border-top:1px solid var(--black);
      box-shadow:0 -4px 20px rgba(0,0,0,0.3);
      padding:20px 16px;
      padding-bottom:calc(20px + env(safe-area-inset-bottom));
    }
    .modal h3 { font-size:16px; margin-bottom:16px; }
    .modal input, .modal select, .modal textarea {
      font-size:16px; /* prevents iOS zoom */
      padding:10px 12px;
    }
    .two-col {
      grid-template-columns:1fr;
    }
    .modal-actions {
      flex-wrap:wrap;
      gap:10px;
    }
    .modal-actions .btn-cancel,
    .modal-actions .btn-save {
      padding:12px 18px;
      font-size:12px;
    }
    .modal-actions .btn-brief,
    .modal-actions .delete-link {
      font-size:10px;
      padding:10px 12px;
    }

    /* ── AI WORKSPACE ── */
    .ai-topbar {
      height:48px;
      padding:0 12px;
      padding-top:env(safe-area-inset-top);
      gap:8px;
    }
    .ai-topbar-title { font-size:12px; }
    .ai-back { font-size:9px; padding:6px 10px; }

    .ai-body { flex-direction:column; }
    .ai-context {
      width:100%;
      max-height:180px;
      overflow-y:auto;
      border-right:none;
      border-bottom:1px solid var(--divider);
      padding:12px;
    }
    .ai-chat { flex:1; min-height:0; }
    .ai-messages { padding:12px; }
    .ai-input-bar { padding:10px 12px; padding-bottom:calc(10px + env(safe-area-inset-bottom)); }
    .ai-input { font-size:16px; /* prevents iOS zoom */ }

    /* ── CARD STYLING ── */
    .card { padding:12px 14px; }
    .card-title { font-size:14px; }
    .card-note { font-size:12px; }
    .card-fn-badge { font-size:10px; padding:3px 7px; }
    .card-owner-av { width:24px; height:24px; font-size:9px; }
    .card-link { font-size:10px; }
    .card-due { font-size:10px; }
    .card-age { font-size:10px; }
    .card-next-action { font-size:12px; }

    /* ── COLUMN HEADERS ── */
    .col-header { height:44px; padding:0 14px; }
    .col-header h2 { font-size:11px; }
    .col-count { font-size:10px; }

    /* ── PILLAR PANE on mobile ── */
    .pr-name { font-size:13px; }
    .pr-desc { font-size:11px; }
    .pr-count { font-size:20px; }
    .pillar-row { padding:14px 16px; }
    .pr-edit { opacity:1; font-size:10px; padding:4px 10px; }

    /* ── FUNCTION PANE on mobile ── */
    .fn-row { padding:14px 16px; gap:12px; }
    .fn-label { font-size:13px; }
    .fn-badge { font-size:10px; padding:2px 8px; }
    .fn-tooltip { display:none !important; }

    /* ── TOUCH TARGETS ── */
    .pillar-row { min-height:44px; }
    .fn-row { min-height:44px; }

    /* ── BOTTOM NAV ── */
    .mobile-bottom-nav {
      display:flex;
      position:fixed;
      bottom:0; left:0; right:0;
      height:52px;
      padding-bottom:env(safe-area-inset-bottom);
      background:var(--black);
      border-top:1px solid rgba(255,255,255,0.15);
      z-index:110;
      align-items:center;
      justify-content:space-around;
    }
    .mobile-nav-btn {
      flex:1; display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      gap:2px; background:none; border:none;
      color:rgba(255,255,255,0.4); cursor:pointer;
      font-family:'Noto Sans',sans-serif; font-size:9px;
      font-weight:600; letter-spacing:0.08em; text-transform:uppercase;
      padding:8px 0; height:52px;
    }
    .mobile-nav-btn.active { color:var(--white); }
    .mobile-nav-btn svg { width:20px; height:20px; }

    /* ── COLUMN DOTS INDICATOR ── */
    .mobile-col-dots {
      display:flex; justify-content:center; gap:6px;
      padding:6px 0;
      background:var(--beige);
      border-bottom:1px solid var(--divider);
    }
    .mobile-col-dot {
      width:8px; height:8px;
      background:var(--soft-gray);
      border-radius:50%;
      transition:background 0.2s;
    }
    .mobile-col-dot.active { background:var(--black); }

    /* ── ACTION SHEET ── */
    .mobile-action-sheet {
      display:none; position:fixed;
      bottom:0; left:0; right:0;
      background:var(--white);
      border-top:1px solid var(--black);
      z-index:200;
      padding-bottom:env(safe-area-inset-bottom);
      box-shadow:0 -4px 20px rgba(0,0,0,0.3);
    }
    .mobile-action-sheet.open { display:block; }
    .mobile-action-sheet-header {
      padding:16px; border-bottom:1px solid var(--divider);
      font-size:14px; font-weight:700; color:var(--black);
    }
    .mobile-action-sheet-section {
      padding:8px 0;
      border-bottom:1px solid var(--divider);
    }
    .mobile-action-sheet-label {
      padding:4px 16px;
      font-size:9px; font-weight:700; letter-spacing:0.12em;
      text-transform:uppercase; color:var(--mid);
    }
    .mobile-action-sheet button {
      display:block; width:100%; text-align:left;
      background:none; border:none;
      padding:14px 16px;
      font-family:'Noto Sans',sans-serif; font-size:14px;
      font-weight:500; color:var(--black); cursor:pointer;
    }
    .mobile-action-sheet button:hover { background:var(--beige); }
    .mobile-action-sheet button.active-col {
      color:var(--red); font-weight:700;
    }
    .mobile-action-sheet-cancel {
      padding:8px;
    }
    .mobile-action-sheet-cancel button {
      text-align:center; font-weight:700;
      color:var(--mid); font-size:12px;
      letter-spacing:0.08em; text-transform:uppercase;
    }

    /* ── EMPTY COLUMN ── */
    .empty-col { padding:32px 16px; font-size:10px; }

    /* ── MISC ── */
    .cards-container { padding:8px 10px; gap:8px; }
    .pane-header { height:44px; padding:0 16px; }
    .pane-title { font-size:10px; }
  }
</style>
</head>
<body>

<!-- ── HEADER ── -->
<header>
  <div class="hdr-brand">
    <div class="hdr-isotype">M</div>
    <span class="hdr-wordmark">Meticulous</span>
    <span class="hdr-subtitle">Priority Board</span>
  </div>
  <div class="hdr-right">
    <span class="today" id="today-date"></span>
    <span id="save-status" style="font-size:9px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;margin-right:12px;padding:3px 8px;color:rgba(255,255,255,0.35);cursor:default"></span>
    <button class="btn btn-secondary standalone-btn" style="display:none" onclick="triggerImport()">Import</button>
    <button class="btn btn-secondary standalone-btn" style="display:none" onclick="exportBoardMd()">Export</button>
    <button class="btn btn-secondary" onclick="document.getElementById('settings-modal').classList.add('open');loadSettingsModal()">Settings</button>
    <button class="btn btn-secondary" onclick="openCardModal()">+ Card</button>
    <button class="btn btn-secondary" onclick="document.getElementById('owner-modal').classList.add('open');renderOwnerModal()">Team</button>
    <button class="btn btn-primary" onclick="openPillarModal()">+ Pillar</button>
    <button class="mobile-overflow-btn" onclick="toggleMobileOverflow(event)" aria-label="More options">⋯</button>
    <div class="mobile-overflow-menu" id="mobile-overflow-menu">
      <button class="standalone-mobile-btn" style="display:none" onclick="closeMobileOverflow();triggerImport()">Import Board.md</button>
      <button class="standalone-mobile-btn" style="display:none" onclick="closeMobileOverflow();exportBoardMd()">Export Board.md</button>
      <button onclick="closeMobileOverflow();document.getElementById('settings-modal').classList.add('open');loadSettingsModal()">Settings</button>
      <button onclick="closeMobileOverflow();document.getElementById('owner-modal').classList.add('open');renderOwnerModal()">Manage Team</button>
      <button onclick="closeMobileOverflow();openPillarModal()">+ Pillar</button>
    </div>
  </div>
</header>

<div class="app">

  <!-- ══ PANE 1: PILLARS ══ -->
  <div class="pane" id="pane-pillars">
    <div class="pane-header"><span class="pane-title">Pillars</span></div>
    <div class="pane-body" id="pillar-list"></div>
  </div>

  <!-- ══ PANE 2: FUNCTIONS ══ -->
  <div class="pane" id="pane-functions">
    <div class="pane-header"><span class="pane-title">Functions</span></div>
    <div class="pane-body" id="fn-list"></div>
  </div>

  <!-- ══ PANE 3: KANBAN ══ -->
  <div class="kanban-area">

    <div class="active-filter-bar" id="active-filter-bar" style="display:none">
      <span class="active-filter-label">Viewing</span>
      <span id="active-filter-chips" style="display:flex;gap:6px;flex-wrap:wrap"></span>
      <button class="clear-all-btn" onclick="clearAllFilters()">Clear all ×</button>
    </div>

    <div class="sub-filter-bar">
      <span class="filter-label">View</span>
      <button class="pill active" data-view="functions" onclick="setView('functions',this)">Functions</button>
      <button class="pill" data-view="priority" onclick="setView('priority',this)">Priority</button>
      <button class="pill" data-view="stage" onclick="setView('stage',this)">Stage</button>
      <div class="filter-sep"></div>
      <span class="filter-label">Owner</span>
      <button class="pill active" data-owner="all" onclick="filterOwner('all',this)">All</button>
      <span id="owner-filter-pills" style="display:contents"></span>
      <div class="filter-sep"></div>
      <span class="filter-label">Priority</span>
      <button class="pill active" data-pri="all" onclick="filterPri('all',this)">All</button>
      <button class="pill" data-pri="high" onclick="filterPri('high',this)" style="display:inline-flex;align-items:center;gap:2px"><span class="pri-dot filled"></span><span class="pri-dot filled"></span><span class="pri-dot filled"></span></button>
      <button class="pill" data-pri="medium" onclick="filterPri('medium',this)" style="display:inline-flex;align-items:center;gap:2px"><span class="pri-dot filled"></span><span class="pri-dot filled"></span><span class="pri-dot"></span></button>
      <button class="pill" data-pri="low" onclick="filterPri('low',this)" style="display:inline-flex;align-items:center;gap:2px"><span class="pri-dot filled"></span><span class="pri-dot"></span><span class="pri-dot"></span></button>
      <div class="filter-sep"></div>
      <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:9px;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;color:var(--mid)">
        <input type="checkbox" id="hide-done-cb" onchange="toggleHideDone(this.checked)" style="cursor:pointer;margin:0">Hide Done
      </label>
      <div class="filter-sep"></div>
      <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:9px;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;color:var(--mid)">
        <input type="checkbox" id="compact-cb" onchange="toggleCompact(this.checked)" style="cursor:pointer;margin:0">Compact
      </label>
    </div>

    <div class="board" id="board"></div>
  </div>
</div>

<!-- ════ CARD MODAL ════ -->
<div class="modal-overlay" id="card-modal" onclick="closeOutside(event,'card-modal')">
  <div class="modal">
    <h3 id="card-modal-h">Add Card</h3>
    <div class="form-row"><label>Title</label><input id="c-title" type="text" placeholder="What needs to happen?"></div>
    <div class="form-row"><label>Next Action</label><input id="c-next-action" type="text" placeholder="What's the immediate next step?"></div>
    <div class="form-row"><label>Note / Context</label><textarea id="c-note" placeholder="Blockers, context…"></textarea></div>
    <div class="two-col">
      <div class="form-row"><label>Function</label>
        <select id="c-fn"><option value="">— None —</option></select>
      </div>
      <div class="form-row"><label>Owner</label>
        <select id="c-owner"><option value="">— Unassigned —</option></select>
      </div>
    </div>
    <div class="two-col">
      <div class="form-row"><label>Column</label>
        <select id="c-col">
          <option value="now">Now</option>
          <option value="next">Next Up</option>
          <option value="waiting">Waiting</option>
          <option value="done">Done</option>
        </select>
      </div>
      <div class="form-row"><label>Priority</label>
        <select id="c-priority">
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
        </select>
      </div>
    </div>
    <div class="two-col">
      <div class="form-row"><label>Pillar</label>
        <select id="c-pillar"><option value="">— Untagged —</option></select>
      </div>
      <div class="form-row"><label>Due Date</label><input id="c-due" type="date"></div>
    </div>
    <div class="form-row"><label>Obsidian Link</label><input id="c-link" type="text" placeholder="[[Meticulous/…]]"></div>
    <div class="modal-actions">
      <button class="delete-link" id="card-delete-btn" style="display:none;margin-right:auto" onclick="deleteCard()">Delete Card</button>
      <button class="btn-brief" id="card-brief-btn" style="display:none" onclick="createBrief()">Create Brief</button>
      <button class="btn-brief" id="card-ai-btn" style="display:none" onclick="openAiWorkspace()">AI Assist</button>
      <button class="btn-cancel" onclick="closeCardModal()">Cancel</button>
      <button class="btn-save" onclick="saveCard()">Save</button>
    </div>
  </div>
</div>

<!-- ════ PILLAR MODAL ════ -->
<div class="modal-overlay" id="pillar-modal" onclick="closeOutside(event,'pillar-modal')">
  <div class="modal">
    <h3 id="pillar-modal-h">Add Pillar</h3>
    <div class="form-row"><label>Name</label><input id="p-name" type="text" placeholder="e.g. Growth, Quality, Community"></div>
    <div class="form-row"><label>Description</label><textarea id="p-desc" placeholder="What this pillar means for Meticulous…"></textarea></div>
    <div class="form-row"><label>Icon</label><div class="emoji-options" id="emoji-options"></div></div>
    <div class="form-row"><label>Color</label><div class="color-options" id="color-options"></div></div>
    <div class="modal-actions">
      <button class="delete-link" id="pillar-delete-btn" style="display:none;margin-right:auto" onclick="deletePillar()">Delete Pillar</button>
      <button class="btn-cancel" onclick="closePillarModal()">Cancel</button>
      <button class="btn-save" onclick="savePillar()">Save</button>
    </div>
  </div>
</div>

<!-- ════ SETTINGS MODAL ════ -->
<div class="modal-overlay" id="settings-modal" onclick="closeOutside(event,'settings-modal')">
  <div class="modal">
    <h3>Settings</h3>
    <div style="padding:14px;background:var(--beige);border:1px solid var(--divider);margin-bottom:16px;">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
        <div id="server-dot" style="width:8px;height:8px;background:var(--soft-gray);flex-shrink:0;"></div>
        <span style="font-size:11px;font-weight:600;color:var(--black)" id="server-status-text">Checking server…</span>
      </div>
      <div style="font-size:10px;color:var(--mid);line-height:1.6">The board reads and writes a single .md file in your Obsidian vault.<br>Changes save automatically. Edit the file in Obsidian and it updates here within seconds.</div>
    </div>
    <div class="form-row"><label>Obsidian Vault Path</label><input id="s-vault" type="text" placeholder="e.g. /Users/yourname/Documents/Obsidian"></div>
    <div class="form-row"><label>Board File (inside vault)</label><input id="s-board-file" type="text" placeholder="e.g. Meticulous/Board.md"></div>
    <div class="modal-actions"><button class="btn-cancel" onclick="document.getElementById('settings-modal').classList.remove('open')">Close</button><button class="btn-save" onclick="saveSettings()">Save Settings</button></div>
  </div>
</div>

<input type="file" id="import-file-input" accept=".md,.txt,text/plain" style="display:none" onchange="handleFileImport(this)">

<!-- ════ OWNER MODAL ════ -->
<div class="modal-overlay" id="owner-modal" onclick="closeOutside(event,'owner-modal')">
  <div class="modal">
    <h3>Manage Team</h3>
    <div id="owner-list" style="display:flex;flex-direction:column;margin-bottom:16px;"></div>
    <div style="display:flex;gap:8px;align-items:center;padding-top:12px;border-top:1px solid var(--divider);">
      <input id="new-owner-name" type="text" placeholder="Name" style="flex:1;padding:8px 10px;border:1px solid var(--divider);font-family:'Noto Sans',sans-serif;font-size:13px;outline:none;background:var(--beige);">
      <input id="new-owner-initials" type="text" placeholder="Init" style="width:58px;padding:8px 10px;border:1px solid var(--divider);font-family:'Noto Sans',sans-serif;font-size:12px;outline:none;text-transform:uppercase;background:var(--beige);" maxlength="3">
      <input id="new-owner-color" type="color" value="#F0380F" style="width:36px;height:36px;border:1px solid var(--divider);cursor:pointer;padding:2px;background:var(--beige);">
      <button class="btn-save" onclick="addOwner()" style="padding:8px 14px;">Add</button>
    </div>
    <div class="modal-actions"><button class="btn-cancel" onclick="document.getElementById('owner-modal').classList.remove('open')">Close</button></div>
  </div>
</div>

<!-- ════ AI WORKSPACE ════ -->
<div class="ai-workspace" id="ai-workspace">
  <div class="ai-topbar">
    <button class="ai-back" onclick="closeAiWorkspace()">&larr; Board</button>
    <span class="ai-topbar-title" id="ai-card-title"></span>
    <button class="ai-back" id="ai-save-btn" onclick="saveAiOutput()">Save to Vault</button>
  </div>
  <div class="ai-body">
    <div class="ai-context" id="ai-context"></div>
    <div class="ai-chat">
      <div class="ai-messages" id="ai-messages"></div>
      <div class="ai-input-bar">
        <textarea class="ai-input" id="ai-input" placeholder="Ask Claude to help with this task..." rows="1"></textarea>
        <button class="ai-send" id="ai-send-btn" onclick="sendAiMessage()">Send</button>
      </div>
    </div>
  </div>
</div>

<!-- ════ MOBILE BOTTOM NAV ════ -->
<nav class="mobile-bottom-nav" id="mobile-bottom-nav">
  <button class="mobile-nav-btn active" id="mnav-board" onclick="mobileShowPane('board')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="18" rx="1"/><rect x="14" y="3" width="7" height="10" rx="1"/></svg>
    Board
  </button>
  <button class="mobile-nav-btn" id="mnav-pillars" onclick="mobileShowPane('pillars')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 3v18M3 12h18"/></svg>
    Pillars
  </button>
  <button class="mobile-nav-btn" id="mnav-functions" onclick="mobileShowPane('functions')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 12h16M4 18h16"/><circle cx="8" cy="6" r="1.5" fill="currentColor"/><circle cx="14" cy="12" r="1.5" fill="currentColor"/><circle cx="10" cy="18" r="1.5" fill="currentColor"/></svg>
    Functions
  </button>
</nav>

<!-- ════ MOBILE ACTION SHEET ════ -->
<div class="mobile-action-sheet" id="mobile-action-sheet">
  <div class="mobile-action-sheet-header" id="action-sheet-title"></div>
  <div class="mobile-action-sheet-section">
    <div class="mobile-action-sheet-label">Move to</div>
    <button onclick="mobileActionMove('now')">Now</button>
    <button onclick="mobileActionMove('next')">Next Up</button>
    <button onclick="mobileActionMove('waiting')">Waiting</button>
    <button onclick="mobileActionMove('done')">Done</button>
  </div>
  <div class="mobile-action-sheet-section">
    <button onclick="mobileActionEdit()">Edit Card</button>
  </div>
  <div class="mobile-action-sheet-cancel">
    <button onclick="closeMobileActionSheet()">Cancel</button>
  </div>
</div>

<script>
// ─────────────────────────────────────────
// DATA
// ─────────────────────────────────────────
const FUNCTIONS = {
  finops:        { label:'Financial & Ops Plan', short:'Fin/Ops',       responsibilities:['Set company budget, approve compensation','Own Financial and Operating Model','Determine manufacturing batch sizes & timing','Approve and sign EPW Purchase Orders','Allocate gross margin across manufacturing, expenses, new products'] },
  marketing:     { label:'Marketing',            short:'Marketing',      responsibilities:['Drive new sales','Determine marketing strategy and focus areas','Define and maintain Brand','Drive awareness with influencers and community','Content creation'] },
  operations:    { label:'Operations',           short:'Operations',     responsibilities:['Own data structure, systems and reporting'] },
  product:       { label:'Product',              short:'Product',        responsibilities:['Prioritize product roadmap (Hardware, Software)','Decide on any product changes (Design, Components)'] },
  supplychain:   { label:'Supply Chain',         short:'Supply Chain',   responsibilities:['Define and own supply chain software tools with EPW','Ensure 2 suppliers for each critical component','Ensure POs placed with sufficient lead-time for batch start dates','IQC: Ensure suppliers meet quality requirements','BOM Reduction: Lower cost on 1–3 high impact components per batch'] },
  manufacturing: { label:'Manufacturing',        short:'Manufacturing',  responsibilities:['Define and own manufacturing software tools with EPW','Ensure batches start on time','Ensure sufficient component inventory without delays','Own SOP, jigs, space and layout for warehousing + assembly','Ensure 100% of units shipped meet quality bar','Ensure certification is current for all countries'] },
  quality:       { label:'Quality',              short:'Quality',        responsibilities:['Determine QC testing SOP for finished product, sub-assemblies, components','Determine QC process (recording and inputting into system)'] },
  fulfillment:   { label:'Fulfillment / Shipping',short:'Fulfillment',   responsibilities:['Select and negotiate fulfillment partner','Ensure customers receive machines on time','Coordinate with shipping partner on delays, damage and lost products','Ensure regulatory requirements met for each country'] },
  website:       { label:'Website',              short:'Website',        responsibilities:['Decide on language, layout, conversion of website'] },
  software:      { label:'Software',             short:'Software',       responsibilities:['Stable release for manufacturing image and customers','Deliver on software roadmap','Firmware, Dial App, iOS/Android/Web App'] },
  support:       { label:'Customer Support',     short:'Support',        responsibilities:['Voice of the Customer in internal meetings','Handle support requests and backer communication','Coordinate product repairs and replacements'] },
  roast:         { label:'Roast / Café Partners',short:'Roast/Café',     responsibilities:['Own relationships with Reseller and Referral partners','Drive sales through referral partners','Organize partner events'] },
  ip:            { label:'IP',                   short:'IP',             responsibilities:['Register patents and trademarks','Litigation'] },
  accounting:    { label:'Accounting & Taxes',   short:'Accounting',     responsibilities:['Ensure accurate books','Manage tax payments','Salaries and payments'] },
  legal:         { label:'Legal',                short:'Legal',          responsibilities:['Manage corporate legal documents and status','Duvall Lawsuit'] },
};

const PILLAR_COLORS = ['#F0380F','#1F1F1F','#1565C0','#2E7D32','#6A1B9A','#E65100','#00695C','#C62828'];
const EMOJIS = ['🚀','📦','🛠','💬','🌍','🤝','⭐','🔬','💡','🏆','🎯','📈','🔗','🧪','🏗','☕','🔥','💎','🌱','🎨'];

let owners = [];
let pillars = [];
let cards = [];
let nextCardId = 0;
let dragId=null, dragColKey=null, dragFnKey=null, justDragged=false;
let fnOrder = Object.keys(FUNCTIONS);
let activePillar='all', activeFn='all', activeOwner='all', activePri='all', hideDone=localStorage.getItem('mb-hide-done')!=='0', compactMode=false;
let viewMode = 'functions';
const STAGE_COLS = [
  {key:'now',     label:'Now',     color:'#2E7D32'},
  {key:'next',    label:'Next Up', color:'#1565C0'},
  {key:'waiting', label:'Waiting', color:'#E65100'},
  {key:'done',    label:'Done',    color:'#D9D9D9'}
];
const FN_COLORS = {
  finops:'#B8A050', marketing:'#F0380F', operations:'#1565C0', product:'#2E7D32',
  supplychain:'#E65100', manufacturing:'#6A1B9A', quality:'#F9A825', fulfillment:'#00695C',
  website:'#558B2F', software:'#00838F', support:'#BF360C', roast:'#6A1B9A',
  ip:'#9C27B0', accounting:'#2E7D32', legal:'#C62828'
};
const PRI_COLS = [
  {key:'high',   label:'High',   color:'#F0380F'},
  {key:'medium', label:'Medium', color:'#E65100'},
  {key:'low',    label:'Low',    color:'#D9D9D9'}
];
let editingCardId=null, editingPillarId=null;
let aiAvailable = false;
let selectedEmoji='🎯', selectedColor=PILLAR_COLORS[0];
let vaultName = '';
let standaloneMode = false;
const STANDALONE_LS_KEY = 'meticulous-board-standalone';

// ─────────────────────────────────────────
// PILLARS
// ─────────────────────────────────────────
function renderPillars() {
  const list = document.getElementById('pillar-list');
  let html = `<div class="pillar-row ${activePillar==='all'?'sel':''}" onclick="setPillar('all')">
    <div class="pr-top"><span class="pr-icon">🗂</span><span class="pr-count">${cards.filter(c=>c.col!=='done').length}</span></div>
    <div class="pr-name">All Priorities</div>
  </div>`;
  pillars.forEach(p => {
    const sel = activePillar===p.id;
    const open = cards.filter(c=>c.pillarId===p.id&&c.col!=='done').length;
    const total = cards.filter(c=>c.pillarId===p.id).length;
    const pct = total>0 ? Math.round(cards.filter(c=>c.pillarId===p.id&&c.col==='done').length/total*100) : 0;
    html += `<div class="pillar-row ${sel?'sel':''}" onclick="setPillar('${p.id}')">
      <button class="pr-edit" onclick="event.stopPropagation();openPillarModal('${p.id}')">Edit</button>
      <div class="pr-top"><span class="pr-icon">${p.icon}</span><span class="pr-count" style="${!sel?'color:'+p.color:''}">${open}</span></div>
      <div class="pr-name" style="${!sel?'color:'+p.color:''}">${p.name}</div>
      <div class="pr-desc">${p.desc}</div>
      <div class="pr-bar"><div class="pr-bar-fill" style="width:${pct}%;${!sel?'background:'+p.color:''}"></div></div>
    </div>`;
  });
  list.innerHTML = html;
}

// ─────────────────────────────────────────
// FUNCTIONS
// ─────────────────────────────────────────
function renderFnList() {
  const list = document.getElementById('fn-list');
  let html = `<div class="fn-row ${activeFn==='all'?'sel':''}" onclick="setFn('all')">
    <div class="fn-dot" style="background:#1F1F1F"></div>
    <span class="fn-label">All Functions</span>
  </div>`;
  fnOrder.forEach(key => {
    const fn = FUNCTIONS[key];
    if (!fn) return;
    const open = cards.filter(c=>c.fn===key&&c.col!=='done').length;
    html += `<div class="fn-row ${activeFn===key?'sel':''}" data-fn-key="${key}" draggable="true"
      onclick="setFn('${key}')"
      ondragstart="onFnRowDragStart(event,'${key}')" ondragend="onFnRowDragEnd()"
      ondragover="onFnRowDragOver(event)" ondrop="onFnRowDrop(event,'${key}')" ondragleave="onFnRowDragLeave(event)">
      <div class="fn-dot dot-${key}"></div>
      <span class="fn-label">${fn.short}</span>
      ${open>0?`<span class="fn-badge">${open}</span>`:''}
      <div class="fn-tooltip">
        <div class="fn-tooltip-title">${fn.label}</div>
        <ul>${fn.responsibilities.map(r=>`<li>${r}</li>`).join('')}</ul>
      </div>
    </div>`;
  });
  list.innerHTML = html;
}

// ─────────────────────────────────────────
// ACTIVE FILTER BAR
// ─────────────────────────────────────────
function renderActiveFilterBar() {
  const bar = document.getElementById('active-filter-bar');
  const chips = document.getElementById('active-filter-chips');
  const parts = [];
  if (activePillar!=='all') {
    const p = pillars.find(x=>x.id===activePillar);
    if (p) parts.push(`<span class="active-filter-chip" style="background:${p.color};border-color:${p.color}" onclick="setPillar('all')">${p.icon} ${p.name} <span class="chip-clear">×</span></span>`);
  }
  if (activeFn!=='all') {
    const fn = FUNCTIONS[activeFn];
    if (fn) parts.push(`<span class="active-filter-chip" onclick="setFn('all')">${fn.short} <span class="chip-clear">×</span></span>`);
  }
  if (parts.length>0) {
    bar.style.display='flex';
    chips.innerHTML=parts.join('');
  } else {
    bar.style.display='none';
    chips.innerHTML='';
  }
}

// ─────────────────────────────────────────
// FILTERS
// ─────────────────────────────────────────
function setPillar(id){activePillar=id;renderAll();}
function setFn(key){activeFn=key;renderAll();}
function filterOwner(id,el){activeOwner=id;document.querySelectorAll('[data-owner]').forEach(p=>p.classList.remove('active'));el.classList.add('active');renderKanban();}
function filterPri(pri,el){activePri=pri;document.querySelectorAll('[data-pri]').forEach(p=>p.classList.remove('active'));el.classList.add('active');renderKanban();}
function clearAllFilters(){activePillar='all';activeFn='all';renderAll();}
function toggleHideDone(v){hideDone=v;localStorage.setItem('mb-hide-done',v?'1':'0');renderKanban();}
function toggleCompact(v){compactMode=v;renderKanban();}
function setView(mode,el){viewMode=mode;document.querySelectorAll('[data-view]').forEach(p=>p.classList.remove('active'));el.classList.add('active');renderKanban();}

// ─────────────────────────────────────────
// KANBAN
// ─────────────────────────────────────────
function getColumnDefs() {
  if (viewMode==='functions') {
    const usedFns = new Set(cards.map(c=>c.fn).filter(Boolean));
    return fnOrder.filter(k=>usedFns.has(k)).map(k=>({key:k, label:FUNCTIONS[k].short, color:FN_COLORS[k]||'#8A8A88', field:'fn'}));
  }
  if (viewMode==='priority') return PRI_COLS.map(c=>({...c, field:'priority'}));
  return (hideDone ? STAGE_COLS.filter(c=>c.key!=='done') : STAGE_COLS).map(c=>({...c, field:'col'}));
}

function renderKanban() {
  const board = document.getElementById('board');
  const cols = getColumnDefs();
  const isFn = viewMode==='functions';
  board.style.gridTemplateColumns = cols.map(()=>isFn?'minmax(220px,1fr)':'1fr').join(' ');

  board.innerHTML = cols.map(def => {
    const filtered = cards.filter(c =>
      c[def.field]===def.key &&
      (!hideDone||c.col!=='done') &&
      (activePillar==='all'||c.pillarId===activePillar) &&
      (activeFn==='all'||c.fn===activeFn) &&
      (activeOwner==='all'||c.ownerId===activeOwner) &&
      (activePri==='all'||c.priority===activePri)
    );
    const cardsHtml = filtered.length===0
      ? '<div class="empty-col">No items</div>'
      : filtered.map(cardHTML).join('');
    const colDrag = isFn ? `draggable="true" ondragstart="onColDragStart(event,'${def.key}')" ondragend="onColDragEnd()" style="cursor:grab"` : '';
    return `<div class="column" data-col-key="${def.key}" ondragover="${isFn?'onColDragOver(event)':''}" ondrop="${isFn?`onColDrop(event,'${def.key}')`:''}" ondragleave="${isFn?'onColDragLeave(event)':''}">
      <div class="col-header" style="border-top:2px solid ${def.color}" ${colDrag}>
        <div class="kdot" style="background:${def.color}"></div>
        <h2>${def.label}</h2>
        <span class="col-count">${filtered.length}</span>
      </div>
      <div class="cards-container${compactMode?' compact':''}" ondragover="onDragOver(event)" ondrop="onDrop(event,'${def.key}')" ondragleave="onDragLeave(event)">${cardsHtml}</div>
    </div>`;
  }).join('');
}

function renderNote(text) {
  let s = text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  s = s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  s = s.replace(/(^|\n)- /g,'$1\u2022 ');
  return s;
}
function priDots(pri) {
  const n = pri==='high'?3:pri==='medium'?2:pri==='low'?1:0;
  return [0,1,2].map(i=>`<span class="pri-dot${i<n?' filled':''}"></span>`).join('');
}
function cardHTML(c) {
  const fn = FUNCTIONS[c.fn];
  const pillar = pillars.find(p=>p.id===c.pillarId);
  const stripe = pillar ? `<span class="card-pillar-stripe" style="background:${pillar.color}" title="${pillar.name}"></span>` : '';
  const o = owners.find(x=>x.id===c.ownerId);
  const av = o ? `<span class="card-owner-av" style="background:${o.color};width:20px;height:20px;font-size:8px" title="${o.name}">${o.initials}</span>` : '';
  let linkHtml = '<span></span>';
  if (c.link) {
    const inner = c.link.replace(/^\[\[|\]\]$/g, '');
    const href = vaultName ? `obsidian://open?vault=${encodeURIComponent(vaultName)}&file=${encodeURIComponent(inner)}` : '#';
    linkHtml = `<a class="card-link" href="${href}" onclick="event.stopPropagation()">${c.link}</a>`;
  }
  let dueHtml = '';
  let dueCls = '';
  if (c.due) {
    const today = new Date(); today.setHours(0,0,0,0);
    const dueDate = new Date(c.due + 'T00:00:00');
    const diffDays = Math.round((dueDate - today) / 86400000);
    const cls = diffDays < 0 ? 'due-overdue' : diffDays <= 3 ? 'due-soon' : 'due-ok';
    if (diffDays < 0) dueCls = 'card-overdue';
    else if (diffDays <= 3) dueCls = 'card-due-soon';
    const label = diffDays < 0 ? `${-diffDays}d overdue` : diffDays === 0 ? 'Today' : diffDays === 1 ? 'Tomorrow' : `${diffDays}d`;
    dueHtml = `<span class="card-due ${cls}" title="${c.due}">${label}</span>`;
  }
  let ageHtml = '';
  if (c.movedAt && c.col !== 'done') {
    const today = new Date(); today.setHours(0,0,0,0);
    const moved = new Date(c.movedAt + 'T00:00:00');
    const ageDays = Math.max(0, Math.round((today - moved) / 86400000));
    let ageLabel, ageCls;
    if (ageDays >= 30) { ageLabel = Math.floor(ageDays/30) + 'mo'; }
    else if (ageDays >= 14) { ageLabel = Math.floor(ageDays/7) + 'w'; }
    else { ageLabel = ageDays + 'd'; }
    if (ageDays <= 2) ageCls = 'age-fresh';
    else if (ageDays <= 7) ageCls = 'age-normal';
    else if (ageDays <= 14) ageCls = 'age-stale';
    else ageCls = 'age-stuck';
    ageHtml = `<span class="card-age ${ageCls}" title="In column ${ageDays} days">${ageLabel}</span>`;
  }
  const nextActionHtml = c.nextAction ? `<div class="card-next-action">\u25B8 ${c.nextAction}</div>` : '';
  return `<div class="card${dueCls?' '+dueCls:''}" id="card-${c.id}" draggable="true"
    ondragstart="onDragStart(event,${c.id})" ondragend="onDragEnd()" onclick="onCardClick(${c.id})">
    <div class="card-top">
      <span class="card-fn-badge fn-${c.fn}">${fn?fn.short:c.fn}</span>${stripe}${av}
    </div>
    <div class="card-title">${c.title}</div>
    ${nextActionHtml}
    ${c.note?`<div class="card-note">${renderNote(c.note)}</div>`:''}
    <div class="card-footer">${linkHtml}${dueHtml}${ageHtml}<div class="card-pri" title="${c.priority}">${priDots(c.priority)}</div></div>
  </div>`;
}

function renderAll(){renderPillars();renderFnList();renderActiveFilterBar();renderKanban();}

// ─────────────────────────────────────────
// DRAG & DROP
// ─────────────────────────────────────────
function onCardClick(id){if(justDragged){justDragged=false;return;}openCardModal(id);}
function onDragStart(e,id){dragId=id;setTimeout(()=>{const el=document.getElementById('card-'+id);if(el)el.classList.add('dragging');},0);}
function onDragEnd(){if(dragId!==null)justDragged=true;setTimeout(()=>justDragged=false,0);dragId=null;dragColKey=null;document.querySelectorAll('.card').forEach(c=>c.classList.remove('dragging'));document.querySelectorAll('.cards-container').forEach(c=>{c.classList.remove('drag-over');c.querySelectorAll('.drop-indicator').forEach(d=>d.remove());});document.querySelectorAll('.column').forEach(c=>c.classList.remove('col-dragging','col-drag-over'));}
function onDragOver(e){
  e.preventDefault();
  const container=e.currentTarget;
  container.classList.add('drag-over');
  container.querySelectorAll('.drop-indicator').forEach(d=>d.remove());
  const cardEls=[...container.querySelectorAll('.card:not(.dragging)')];
  let before=null;
  for(const el of cardEls){const rect=el.getBoundingClientRect();if(e.clientY<rect.top+rect.height/2){before=el;break;}}
  const ind=document.createElement('div');ind.className='drop-indicator';
  if(before)container.insertBefore(ind,before);else container.appendChild(ind);
}
function onDragLeave(e){if(!e.currentTarget.contains(e.relatedTarget)){e.currentTarget.classList.remove('drag-over');e.currentTarget.querySelectorAll('.drop-indicator').forEach(d=>d.remove());}}
function onDrop(e,targetKey){
  e.preventDefault();
  const container=e.currentTarget;
  container.classList.remove('drag-over');
  container.querySelectorAll('.drop-indicator').forEach(d=>d.remove());
  if(dragId===null)return;
  const card=cards.find(x=>x.id===dragId);
  if(!card)return;
  // Find insertion position
  const cardEls=[...container.querySelectorAll('.card:not(.dragging)')];
  let insertBeforeId=null;
  for(const el of cardEls){const rect=el.getBoundingClientRect();if(e.clientY<rect.top+rect.height/2){insertBeforeId=parseInt(el.id.replace('card-',''));break;}}
  // Remove card from array
  cards=cards.filter(c=>c.id!==dragId);
  // Update the correct field based on view mode
  const field = viewMode==='functions'?'fn':viewMode==='priority'?'priority':'col';
  if(field==='col'&&card.col!==targetKey) card.movedAt=new Date().toISOString().slice(0,10);
  card[field]=targetKey;
  // Insert at position
  if(insertBeforeId!==null){const idx=cards.findIndex(c=>c.id===insertBeforeId);cards.splice(idx,0,card);}
  else{let lastIdx=-1;cards.forEach((c,i)=>{if(c[field]===targetKey)lastIdx=i;});cards.splice(lastIdx+1,0,card);}
  dragId=null;renderAll();scheduleSave();
}

// ── COLUMN DRAG (Functions view) ──
function onColDragStart(e,key){
  if(dragId!==null)return; // card drag in progress
  dragColKey=key;
  e.dataTransfer.effectAllowed='move';
  e.stopPropagation();
  setTimeout(()=>{const col=document.querySelector(`.column[data-col-key="${key}"]`);if(col)col.classList.add('col-dragging');},0);
}
function onColDragEnd(){
  dragColKey=null;
  document.querySelectorAll('.column').forEach(c=>{c.classList.remove('col-dragging','col-drag-over');});
}
function onColDragOver(e){
  if(dragColKey===null)return;
  e.preventDefault();
  e.stopPropagation();
  const col=e.currentTarget;
  if(col.dataset.colKey===dragColKey)return;
  document.querySelectorAll('.column').forEach(c=>c.classList.remove('col-drag-over'));
  col.classList.add('col-drag-over');
}
function onColDragLeave(e){
  if(dragColKey===null)return;
  if(!e.currentTarget.contains(e.relatedTarget))e.currentTarget.classList.remove('col-drag-over');
}
function onColDrop(e,targetKey){
  e.preventDefault();
  e.stopPropagation();
  if(dragColKey===null||dragColKey===targetKey)return;
  const fromIdx=fnOrder.indexOf(dragColKey);
  const toIdx=fnOrder.indexOf(targetKey);
  if(fromIdx===-1||toIdx===-1)return;
  fnOrder.splice(fromIdx,1);
  fnOrder.splice(toIdx,0,dragColKey);
  dragColKey=null;
  renderAll();
}

// ── FN ROW DRAG (sidebar reorder) ──
function onFnRowDragStart(e,key){
  dragFnKey=key;
  e.dataTransfer.effectAllowed='move';
  e.stopPropagation();
  setTimeout(()=>{const row=document.querySelector(`.fn-row[data-fn-key="${key}"]`);if(row)row.classList.add('fn-dragging');},0);
}
function onFnRowDragEnd(){
  dragFnKey=null;
  document.querySelectorAll('.fn-row').forEach(r=>r.classList.remove('fn-dragging','fn-drag-over'));
}
function onFnRowDragOver(e){
  if(dragFnKey===null)return;
  e.preventDefault();
  e.stopPropagation();
  const row=e.currentTarget;
  if(row.dataset.fnKey===dragFnKey)return;
  document.querySelectorAll('.fn-row').forEach(r=>r.classList.remove('fn-drag-over'));
  row.classList.add('fn-drag-over');
}
function onFnRowDragLeave(e){
  if(dragFnKey===null)return;
  if(!e.currentTarget.contains(e.relatedTarget))e.currentTarget.classList.remove('fn-drag-over');
}
function onFnRowDrop(e,targetKey){
  e.preventDefault();
  e.stopPropagation();
  if(dragFnKey===null||dragFnKey===targetKey)return;
  const fromIdx=fnOrder.indexOf(dragFnKey);
  const toIdx=fnOrder.indexOf(targetKey);
  if(fromIdx===-1||toIdx===-1)return;
  fnOrder.splice(fromIdx,1);
  fnOrder.splice(toIdx,0,dragFnKey);
  dragFnKey=null;
  renderAll();
}

// ─────────────────────────────────────────
// CARD MODAL
// ─────────────────────────────────────────
function populateFnSelect(sel){document.getElementById('c-fn').innerHTML='<option value="">— None —</option>'+fnOrder.map(k=>{const fn=FUNCTIONS[k];if(!fn)return'';return`<option value="${k}" ${k===sel?'selected':''}>${fn.label}</option>`;}).join('');}
function populatePillarSelect(sel){document.getElementById('c-pillar').innerHTML='<option value="">— Untagged —</option>'+pillars.map(p=>`<option value="${p.id}" ${p.id===sel?'selected':''}>${p.icon} ${p.name}</option>`).join('');}
function populateOwnerSelect(sel){document.getElementById('c-owner').innerHTML='<option value="">— Unassigned —</option>'+owners.map(o=>`<option value="${o.id}" ${o.id===sel?'selected':''}>${o.name}</option>`).join('');}
function openCardModal(id){
  editingCardId=id||null;
  const c=id?cards.find(x=>x.id===id):null;
  document.getElementById('card-modal-h').textContent=c?'Edit Card':'Add Card';
  document.getElementById('c-title').value=c?c.title:'';
  document.getElementById('c-next-action').value=c?c.nextAction:'';
  document.getElementById('c-note').value=c?c.note:'';
  populateFnSelect(c?c.fn:(activeFn!=='all'?activeFn:'operations'));
  document.getElementById('c-col').value=c?c.col:'now';
  document.getElementById('c-priority').value=c?c.priority:'medium';
  document.getElementById('c-link').value=c?c.link:'';
  document.getElementById('c-due').value=c?c.due:'';
  document.getElementById('card-delete-btn').style.display=c?'block':'none';
  const briefBtn=document.getElementById('card-brief-btn');
  briefBtn.style.display=(c&&!standaloneMode)?'inline-block':'none';
  briefBtn.textContent='Create Brief';
  briefBtn.disabled=false;
  document.getElementById('card-ai-btn').style.display=(c&&aiAvailable)?'inline-block':'none';
  populatePillarSelect(c?c.pillarId:(activePillar!=='all'?activePillar:''));
  populateOwnerSelect(c?c.ownerId:'');
  document.getElementById('card-modal').classList.add('open');
  document.getElementById('c-title').focus();
}
function closeCardModal(){document.getElementById('card-modal').classList.remove('open');}
document.getElementById('card-modal').addEventListener('keydown',function(e){if((e.metaKey||e.ctrlKey)&&e.key==='Enter'){e.preventDefault();saveCard();}if(e.key==='Escape'){e.preventDefault();closeCardModal();}});
function saveCard(){
  const title=document.getElementById('c-title').value.trim();
  if(!title){document.getElementById('c-title').focus();return;}
  const newCol=document.getElementById('c-col').value;
  const data={title,note:document.getElementById('c-note').value.trim(),fn:document.getElementById('c-fn').value,
    ownerId:document.getElementById('c-owner').value,col:newCol,
    priority:document.getElementById('c-priority').value,link:document.getElementById('c-link').value.trim(),
    pillarId:document.getElementById('c-pillar').value,due:document.getElementById('c-due').value,
    nextAction:document.getElementById('c-next-action').value.trim()};
  if(editingCardId){
    const existing=cards.find(c=>c.id===editingCardId);
    if(existing.col!==newCol) data.movedAt=new Date().toISOString().slice(0,10);
    Object.assign(existing,data);
  } else {
    const today=new Date().toISOString().slice(0,10);
    cards.push({id:++nextCardId,movedAt:today,...data});
  }
  closeCardModal();renderAll();scheduleSave();
}
function deleteCard(){
  if(!editingCardId)return;
  cards=cards.filter(c=>c.id!==editingCardId);
  closeCardModal();renderAll();scheduleSave();
}
async function createBrief(){
  if(!editingCardId)return;
  const btn=document.getElementById('card-brief-btn');
  btn.textContent='Creating…';btn.disabled=true;
  const c=cards.find(x=>x.id===editingCardId);
  if(!c){btn.textContent='Create Brief';btn.disabled=false;return;}
  const ownerObj=owners.find(o=>o.id===c.ownerId);
  const payload={
    title:document.getElementById('c-title').value.trim()||c.title,
    owner:ownerObj?ownerObj.name:'',
    fn:document.getElementById('c-fn').value||c.fn,
    priority:document.getElementById('c-priority').value||c.priority,
    due:document.getElementById('c-due').value||c.due,
    note:document.getElementById('c-note').value.trim()||c.note
  };
  try{
    const r=await fetch('/api/brief',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const result=await r.json();
    if(result.ok&&result.link){
      document.getElementById('c-link').value=result.link;
      btn.textContent='Brief Created';
      saveCard();
    }else{
      btn.textContent='Failed';setTimeout(()=>{btn.textContent='Create Brief';btn.disabled=false;},2000);
    }
  }catch(e){
    console.warn('Brief creation failed:',e);
    btn.textContent='Failed';setTimeout(()=>{btn.textContent='Create Brief';btn.disabled=false;},2000);
  }
}

// ─────────────────────────────────────────
// PILLAR MODAL
// ─────────────────────────────────────────
function buildEmojiPicker(){document.getElementById('emoji-options').innerHTML=EMOJIS.map(e=>`<span class="emoji-opt ${e===selectedEmoji?'selected':''}" onclick="selectEmoji('${e}',this)">${e}</span>`).join('');}
function buildColorPicker(){document.getElementById('color-options').innerHTML=PILLAR_COLORS.map(c=>`<div class="color-opt ${c===selectedColor?'selected':''}" style="background:${c}" onclick="selectColor('${c}',this)"></div>`).join('');}
function selectEmoji(e,el){selectedEmoji=e;document.querySelectorAll('.emoji-opt').forEach(x=>x.classList.remove('selected'));el.classList.add('selected');}
function selectColor(c,el){selectedColor=c;document.querySelectorAll('.color-opt').forEach(x=>x.classList.remove('selected'));el.classList.add('selected');}
function openPillarModal(id){
  editingPillarId=id||null;
  const p=id?pillars.find(x=>x.id===id):null;
  document.getElementById('pillar-modal-h').textContent=p?'Edit Pillar':'Add Pillar';
  document.getElementById('p-name').value=p?p.name:'';
  document.getElementById('p-desc').value=p?p.desc:'';
  document.getElementById('pillar-delete-btn').style.display=p?'block':'none';
  selectedEmoji=p?p.icon:'🎯';selectedColor=p?p.color:PILLAR_COLORS[0];
  buildEmojiPicker();buildColorPicker();
  document.getElementById('pillar-modal').classList.add('open');
  document.getElementById('p-name').focus();
}
function closePillarModal(){document.getElementById('pillar-modal').classList.remove('open');}
document.getElementById('pillar-modal').addEventListener('keydown',function(e){if((e.metaKey||e.ctrlKey)&&e.key==='Enter'){e.preventDefault();savePillar();}if(e.key==='Escape'){e.preventDefault();closePillarModal();}});
function savePillar(){
  const name=document.getElementById('p-name').value.trim();
  if(!name){document.getElementById('p-name').focus();return;}
  const data={name,desc:document.getElementById('p-desc').value.trim(),icon:selectedEmoji,color:selectedColor};
  if(editingPillarId) Object.assign(pillars.find(p=>p.id===editingPillarId),data);
  else pillars.push({id:'p'+(++nextPillarId),...data});
  closePillarModal();renderAll();scheduleSave();
}
function deletePillar(){
  if(!editingPillarId)return;
  pillars=pillars.filter(p=>p.id!==editingPillarId);
  cards.forEach(c=>{if(c.pillarId===editingPillarId)c.pillarId='';});
  if(activePillar===editingPillarId)activePillar='all';
  closePillarModal();renderAll();scheduleSave();
}

// ─────────────────────────────────────────
// OWNER MODAL
// ─────────────────────────────────────────
function renderOwnerModal(){
  document.getElementById('owner-list').innerHTML=owners.map(o=>
    `<div class="owner-item">
      <div class="owner-av-lg" style="background:${o.color}">${o.initials}</div>
      <span style="font-size:13px;font-weight:500;color:var(--black);flex:1">${o.name}</span>
      <button onclick="removeOwner('${o.id}')" style="background:none;border:none;color:#C62828;cursor:pointer;font-size:16px;font-weight:700;">×</button>
    </div>`).join('');
}
function addOwner(){
  const name=document.getElementById('new-owner-name').value.trim();
  const initials=document.getElementById('new-owner-initials').value.trim().toUpperCase();
  const color=document.getElementById('new-owner-color').value;
  if(!name||!initials)return;
  owners.push({id:'o'+(++nextOwnerId),name,initials,color});
  document.getElementById('new-owner-name').value='';
  document.getElementById('new-owner-initials').value='';
  renderOwnerModal();renderOwnerPills();renderAll();scheduleSave();
}
function removeOwner(id){
  owners=owners.filter(o=>o.id!==id);
  cards.forEach(c=>{if(c.ownerId===id)c.ownerId='';});
  renderOwnerModal();renderOwnerPills();renderAll();scheduleSave();
}
function renderOwnerPills(){
  document.getElementById('owner-filter-pills').innerHTML=owners.map(o=>
    `<button class="pill" data-owner="${o.id}" onclick="filterOwner('${o.id}',this)">${o.initials}</button>`
  ).join('');
}

function closeOutside(e,id){if(e.target.id===id)document.getElementById(id).classList.remove('open');}

// ─────────────────────────────────────────
// AI WORKSPACE
// ─────────────────────────────────────────
let aiMessages = [];
let aiCardData = null;
let aiBriefContent = '';
let aiStreaming = false;
let aiFnResponsibilities = [];
let aiPillarDesc = '';

async function openAiWorkspace() {
  if (!editingCardId) return;
  const c = cards.find(x => x.id === editingCardId);
  if (!c) return;

  // Gather card data for context
  const ownerObj = owners.find(o => o.id === c.ownerId);
  const pillarObj = pillars.find(p => p.id === c.pillarId);
  const fnObj = FUNCTIONS[c.fn];

  aiCardData = {
    _cardId: c.id,
    title: document.getElementById('c-title').value.trim() || c.title,
    note: document.getElementById('c-note').value.trim() || c.note,
    nextAction: document.getElementById('c-next-action').value.trim() || c.nextAction,
    fn: document.getElementById('c-fn').value || c.fn,
    owner: ownerObj ? ownerObj.name : '',
    priority: document.getElementById('c-priority').value || c.priority,
    due: document.getElementById('c-due').value || c.due,
    pillar: pillarObj ? pillarObj.name : '',
    col: document.getElementById('c-col').value || c.col,
    movedAt: c.movedAt || '',
    link: document.getElementById('c-link').value.trim() || c.link
  };

  aiFnResponsibilities = fnObj ? fnObj.responsibilities : [];
  aiPillarDesc = pillarObj ? pillarObj.desc : '';

  // Close card modal
  closeCardModal();

  // Fetch brief content if card has a link
  aiBriefContent = '';
  if (aiCardData.link) {
    try {
      const r = await fetch('/api/brief-content?link=' + encodeURIComponent(aiCardData.link));
      const data = await r.json();
      if (data.found) aiBriefContent = data.content;
    } catch(e) { console.warn('Failed to load brief:', e); }
  }

  // Build context sidebar
  const fnLabel = fnObj ? fnObj.label : aiCardData.fn;
  let ctxHtml = '';

  const fields = [
    ['Priority', aiCardData.priority ? aiCardData.priority.charAt(0).toUpperCase() + aiCardData.priority.slice(1) : ''],
    ['Column', aiCardData.col === 'now' ? 'Now' : aiCardData.col === 'next' ? 'Next Up' : aiCardData.col === 'waiting' ? 'Waiting' : 'Done'],
    ['Owner', aiCardData.owner || 'Unassigned'],
    ['Due', aiCardData.due || 'Not set'],
    ['Function', fnLabel || 'None'],
    ['Pillar', aiCardData.pillar || 'None'],
  ];

  fields.forEach(([label, value]) => {
    ctxHtml += `<div class="ai-ctx-section"><div class="ai-ctx-label">${label}</div><div class="ai-ctx-value">${value}</div></div>`;
  });

  if (aiCardData.nextAction) {
    ctxHtml += `<div class="ai-ctx-section"><div class="ai-ctx-label">Next Action</div><div class="ai-ctx-value">${aiCardData.nextAction}</div></div>`;
  }
  if (aiCardData.note) {
    ctxHtml += `<div class="ai-ctx-section"><div class="ai-ctx-label">Note</div><div class="ai-ctx-value">${aiCardData.note}</div></div>`;
  }
  if (aiFnResponsibilities.length > 0) {
    ctxHtml += `<div class="ai-ctx-section"><div class="ai-ctx-label">Function Scope</div><div class="ai-ctx-value">${aiFnResponsibilities.map(r => '• ' + r).join('\n')}</div></div>`;
  }
  if (aiBriefContent) {
    ctxHtml += `<div class="ai-ctx-section" style="border-top:1px solid var(--divider);padding-top:14px;margin-top:8px"><div class="ai-ctx-label">Brief</div><div class="ai-ctx-brief">${escapeHtml(aiBriefContent)}</div></div>`;
  }

  document.getElementById('ai-context').innerHTML = ctxHtml;
  document.getElementById('ai-card-title').textContent = aiCardData.title;

  // Reset conversation
  aiMessages = [];
  document.getElementById('ai-messages').innerHTML = '';
  document.getElementById('ai-input').value = '';

  // Show workspace
  document.getElementById('ai-workspace').classList.add('open');
  document.getElementById('ai-input').focus();
}

function closeAiWorkspace() {
  document.getElementById('ai-workspace').classList.remove('open');
  aiMessages = [];
  aiCardData = null;
  aiBriefContent = '';
  aiStreaming = false;
}

function escapeHtml(text) {
  return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function renderAiMarkdown(text) {
  // Extract code blocks first, replace with placeholders
  const codeBlocks = [];
  text = text.replace(/```(\w*)\n([\s\S]*?)```/g, function(m, lang, code) {
    codeBlocks.push('<pre><code>' + escapeHtml(code.replace(/\n$/, '')) + '</code></pre>');
    return '\x00CB' + (codeBlocks.length - 1) + '\x00';
  });

  const lines = text.split('\n');
  let html = '';
  let inList = false, listType = '';

  function closeList() { if (inList) { html += listType === 'ul' ? '</ul>' : '</ol>'; inList = false; } }
  function inline(t) {
    t = escapeHtml(t);
    t = t.replace(/`([^`]+)`/g, '<code>$1</code>');
    t = t.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    t = t.replace(/\*(.+?)\*/g, '<em>$1</em>');
    return t;
  }

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    // Code block placeholder
    const cbMatch = line.match(/\x00CB(\d+)\x00/);
    if (cbMatch) { closeList(); html += codeBlocks[parseInt(cbMatch[1])]; continue; }

    // Headers
    if (line.startsWith('### ')) { closeList(); html += '<h3>' + inline(line.slice(4)) + '</h3>'; continue; }
    if (line.startsWith('## '))  { closeList(); html += '<h2>' + inline(line.slice(3)) + '</h2>'; continue; }
    if (line.startsWith('# '))   { closeList(); html += '<h1>' + inline(line.slice(2)) + '</h1>'; continue; }

    // Horizontal rule
    if (/^---+$/.test(line)) { closeList(); html += '<hr>'; continue; }

    // Blockquote
    if (line.startsWith('> ')) { closeList(); html += '<blockquote>' + inline(line.slice(2)) + '</blockquote>'; continue; }

    // Unordered list
    if (/^[-*] /.test(line)) {
      if (!inList || listType !== 'ul') { closeList(); html += '<ul>'; inList = true; listType = 'ul'; }
      html += '<li>' + inline(line.replace(/^[-*] /, '')) + '</li>';
      continue;
    }

    // Ordered list
    if (/^\d+\. /.test(line)) {
      if (!inList || listType !== 'ol') { closeList(); html += '<ol>'; inList = true; listType = 'ol'; }
      html += '<li>' + inline(line.replace(/^\d+\. /, '')) + '</li>';
      continue;
    }

    // Empty line
    if (line.trim() === '') { closeList(); continue; }

    // Regular paragraph
    closeList();
    html += '<p>' + inline(line) + '</p>';
  }
  closeList();
  return html;
}

async function sendAiMessage() {
  if (aiStreaming) return;
  const input = document.getElementById('ai-input');
  const text = input.value.trim();
  if (!text) return;

  input.value = '';
  input.style.height = 'auto';

  // Add user message
  aiMessages.push({ role: 'user', content: text });
  const msgContainer = document.getElementById('ai-messages');
  msgContainer.innerHTML += `<div class="ai-msg ai-msg-user">${escapeHtml(text)}</div>`;

  // Create AI response bubble
  const aiMsgEl = document.createElement('div');
  aiMsgEl.className = 'ai-msg ai-msg-ai ai-msg-streaming';
  aiMsgEl.textContent = '';
  msgContainer.appendChild(aiMsgEl);
  msgContainer.scrollTop = msgContainer.scrollHeight;

  // Disable send
  aiStreaming = true;
  document.getElementById('ai-send-btn').disabled = true;

  let fullResponse = '';

  try {
    const resp = await fetch('/api/ai/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        messages: aiMessages.filter(m => m.role === 'user' || m.role === 'assistant'),
        card: aiCardData,
        briefContent: aiBriefContent,
        fnResponsibilities: aiFnResponsibilities,
        pillarDesc: aiPillarDesc
      })
    });

    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    let streamDone = false;

    while (!streamDone) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop() || '';

      for (const line of lines) {
        const trimmed = line.trim();
        if (!trimmed || !trimmed.startsWith('data: ')) continue;
        const data = trimmed.slice(6);
        if (data === '[DONE]') { streamDone = true; break; }

        try {
          const evt = JSON.parse(data);
          if (evt.error) {
            aiMsgEl.className = 'ai-msg ai-msg-error';
            aiMsgEl.textContent = 'Error: ' + evt.error;
            return;
          }
          if (evt.text) {
            fullResponse += evt.text;
            aiMsgEl.textContent = fullResponse;
            msgContainer.scrollTop = msgContainer.scrollHeight;
          }
        } catch(e) {}
      }
    }
    reader.cancel().catch(() => {});

    // Render final markdown
    if (fullResponse) {
      aiMsgEl.className = 'ai-msg ai-msg-ai';
      aiMsgEl.innerHTML = renderAiMarkdown(fullResponse);
      aiMessages.push({ role: 'assistant', content: fullResponse });
      msgContainer.scrollTop = msgContainer.scrollHeight;
    }
  } catch(e) {
    aiMsgEl.className = 'ai-msg ai-msg-error';
    aiMsgEl.textContent = 'Connection error: ' + e.message;
  } finally {
    aiStreaming = false;
    document.getElementById('ai-send-btn').disabled = false;
    document.getElementById('ai-input').focus();
  }
}

function saveAiOutput() {
  // Find last assistant message
  const lastAi = [...aiMessages].reverse().find(m => m.role === 'assistant');
  if (!lastAi) { alert('No AI response to save.'); return; }

  const title = aiCardData ? aiCardData.title : 'AI Output';

  fetch('/api/vault/save', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ title: title, content: lastAi.content })
  }).then(r => r.json()).then(result => {
    if (result.ok && result.link) {
      // Update the card's Obsidian link
      if (aiCardData && aiCardData._cardId) {
        const card = cards.find(c => c.id === aiCardData._cardId);
        if (card) {
          card.link = result.link;
          scheduleSave();
        }
      }
      const btn = document.getElementById('ai-save-btn');
      btn.textContent = 'Saved!';
      setTimeout(() => { btn.textContent = 'Save to Vault'; }, 2000);
    } else {
      alert('Save failed: ' + (result.error || 'Unknown error'));
    }
  }).catch(e => {
    alert('Save failed: ' + e.message);
  });
}

// AI workspace keyboard shortcuts
document.getElementById('ai-input').addEventListener('keydown', function(e) {
  if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') { e.preventDefault(); sendAiMessage(); }
});
document.getElementById('ai-workspace').addEventListener('keydown', function(e) {
  if (e.key === 'Escape') { e.preventDefault(); closeAiWorkspace(); }
});

// Auto-resize textarea
document.getElementById('ai-input').addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// ─────────────────────────────────────────
// SERVER PERSISTENCE
// ─────────────────────────────────────────
let lastMtime = 0;
let saveTimer = null;
let saving = false;
let nextPillarId = 0;
let nextOwnerId = 0;

// ─────────────────────────────────────────
// CLIENT-SIDE BOARD.MD PARSER / SERIALIZER
// ─────────────────────────────────────────
function parsePillarLine(text) {
  const parts = text.split('|').map(s => s.trim());
  if (parts.length < 2) return null;
  let icon = '', name = parts[0];
  const m = parts[0].match(/^(\S+)\s+(.*)/);
  if (m) { icon = m[1]; name = m[2]; }
  return { icon, name, color: parts[1] || '#1F1F1F', desc: parts[2] || '' };
}

function parseOwnerLine(text) {
  const parts = text.split('|').map(s => s.trim());
  if (parts.length < 2) return null;
  return { name: parts[0], initials: parts[1], color: parts[2] || '#1F1F1F' };
}

function parseCardLine(text) {
  const card = { title:'', priority:'medium', owner:'', fn:'', pillar:'', link:'', note:'', due:'', nextAction:'', movedAt:'' };
  let t = text;
  let m;
  // ^YYYY-MM-DD movedAt
  m = t.match(/\^(\d{4}-\d{2}-\d{2})/);
  if (m) { card.movedAt = m[1]; t = t.slice(0, m.index) + t.slice(m.index + m[0].length); }
  // !YYYY-MM-DD due
  m = t.match(/!(\d{4}-\d{2}-\d{2})/);
  if (m) { card.due = m[1]; t = t.slice(0, m.index) + t.slice(m.index + m[0].length); }
  // [[link]]
  m = t.match(/\[\[(.+?)\]\]/);
  if (m) { card.link = '[[' + m[1] + ']]'; t = t.slice(0, m.index) + t.slice(m.index + m[0].length); }
  // [priority]
  m = t.match(/\[(high|medium|low)\]/i);
  if (m) { card.priority = m[1].toLowerCase(); t = t.slice(0, m.index) + t.slice(m.index + m[0].length); }
  // @Owner
  m = t.match(/@(\S+(?:\s+\S+)*?)(?=\s+[#>@\[]|$)/);
  if (m) { card.owner = m[1].trim(); t = t.slice(0, m.index) + t.slice(m.index + m[0].length); }
  // #function
  m = t.match(/#(\S+)/);
  if (m) { card.fn = m[1]; t = t.slice(0, m.index) + t.slice(m.index + m[0].length); }
  // >Pillar
  m = t.match(/>([^*]+)/);
  if (m) { card.pillar = m[1].trim(); t = t.slice(0, m.index) + t.slice(m.index + m[0].length); }
  // **Title**
  m = t.match(/\*\*(.+?)\*\*/);
  if (m) { card.title = m[1].trim(); }
  else { card.title = t.trim().replace(/^-\s*/, '').trim(); }
  return card;
}

function parseBoardMd(text) {
  const result = { pillars: [], owners: [], columns: { now: [], next: [], waiting: [], done: [] } };
  let section = null, colKey = null, currentCard = null;
  for (const rawLine of text.split('\n')) {
    const line = rawLine.trimEnd();
    if (line.startsWith('## ')) {
      const heading = line.slice(3).trim().toLowerCase();
      if (currentCard && colKey) { result.columns[colKey].push(currentCard); currentCard = null; }
      if (heading === 'pillars') { section = 'pillars'; }
      else if (heading === 'team') { section = 'team'; }
      else if (heading === 'now') { section = 'cards'; colKey = 'now'; }
      else if (heading === 'next up' || heading === 'next') { section = 'cards'; colKey = 'next'; }
      else if (heading === 'waiting') { section = 'cards'; colKey = 'waiting'; }
      else if (heading === 'done') { section = 'cards'; colKey = 'done'; }
      else { section = null; }
      continue;
    }
    if (line.startsWith('# ')) continue;
    if (section === 'pillars' && line.startsWith('- ')) {
      const p = parsePillarLine(line.slice(2));
      if (p) result.pillars.push(p);
      continue;
    }
    if (section === 'team' && line.startsWith('- ')) {
      const o = parseOwnerLine(line.slice(2));
      if (o) result.owners.push(o);
      continue;
    }
    if (section === 'cards' && colKey) {
      if (line.startsWith('- ')) {
        if (currentCard) result.columns[colKey].push(currentCard);
        currentCard = parseCardLine(line.slice(2));
      } else if (currentCard && (line.startsWith('  ') || line.startsWith('\t'))) {
        const noteLine = line.trim();
        if (noteLine) {
          if (noteLine.startsWith('>> ') && !currentCard.nextAction) {
            currentCard.nextAction = noteLine.slice(3);
          } else if (currentCard.note) {
            currentCard.note += '\n' + noteLine;
          } else {
            currentCard.note = noteLine;
          }
        }
      }
      continue;
    }
  }
  if (currentCard && colKey) result.columns[colKey].push(currentCard);
  return result;
}

function serializeCardLine(card) {
  const parts = ['- **' + card.title + '**'];
  if (card.priority && card.priority !== 'medium') parts.push('[' + card.priority + ']');
  if (card.owner) parts.push('@' + card.owner);
  if (card.fn) parts.push('#' + card.fn);
  if (card.pillar) parts.push('>' + card.pillar);
  if (card.due) parts.push('!' + card.due);
  if (card.movedAt) parts.push('^' + card.movedAt);
  if (card.link) { parts.push(card.link.startsWith('[[') ? card.link : '[[' + card.link + ']]'); }
  return parts.join(' ');
}

function serializeBoardMd(data) {
  const lines = ['# Meticulous Board', ''];
  lines.push('## Pillars');
  (data.pillars || []).forEach(p => {
    const desc = p.desc ? ' | ' + p.desc : '';
    lines.push('- ' + (p.icon || '\uD83C\uDFAF') + ' ' + p.name + ' | ' + (p.color || '#1F1F1F') + desc);
  });
  lines.push('');
  lines.push('## Team');
  (data.owners || []).forEach(o => {
    lines.push('- ' + o.name + ' | ' + o.initials + ' | ' + (o.color || '#1F1F1F'));
  });
  lines.push('');
  const colHeadings = [['now','Now'],['next','Next Up'],['waiting','Waiting'],['done','Done']];
  const columns = data.columns || {};
  colHeadings.forEach(([key, title]) => {
    lines.push('## ' + title);
    (columns[key] || []).forEach(c => {
      lines.push(serializeCardLine(c));
      if (c.nextAction) lines.push('  >> ' + c.nextAction);
      if (c.note) c.note.split('\n').forEach(nl => lines.push('  ' + nl));
    });
    lines.push('');
  });
  return lines.join('\n');
}

function buildBoardData() {
  const ownerMap = Object.fromEntries(owners.map(o => [o.id, o.name]));
  const pillarMap = Object.fromEntries(pillars.map(p => [p.id, p.name]));
  const boardPillars = pillars.map(p => ({icon:p.icon, name:p.name, color:p.color, desc:p.desc}));
  const boardOwners = owners.map(o => ({name:o.name, initials:o.initials, color:o.color}));
  const columns = {};
  ['now','next','waiting','done'].forEach(col => {
    columns[col] = cards.filter(c => c.col === col).map(c => ({
      title: c.title, priority: c.priority,
      owner: ownerMap[c.ownerId] || '', fn: c.fn || '',
      pillar: pillarMap[c.pillarId] || '',
      link: c.link || '', note: c.note || '',
      due: c.due || '',
      nextAction: c.nextAction || '',
      movedAt: c.movedAt || ''
    }));
  });
  return { pillars: boardPillars, owners: boardOwners, columns };
}

function scheduleSave() {
  if (saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(standaloneMode ? saveToLocalStorage : saveToServer, 300);
}

async function saveToServer() {
  saveTimer = null;
  saving = true;
  const status = document.getElementById('save-status');
  if (status) { status.textContent = 'Saving…'; status.style.color = '#E65100'; }
  try {
    const r = await fetch('/api/board', {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(buildBoardData())
    });
    const result = await r.json();
    if (result.mtime) lastMtime = result.mtime;
    if (status) { status.textContent = 'Saved'; status.style.color = '#2E7D32'; setTimeout(() => { status.textContent = ''; }, 2000); }
  } catch(e) {
    console.warn('Save failed:', e);
    if (status) { status.textContent = 'Save failed'; status.style.color = '#C62828'; }
  } finally {
    saving = false;
  }
}

// ─────────────────────────────────────────
// STANDALONE PERSISTENCE
// ─────────────────────────────────────────
function saveToLocalStorage() {
  saveTimer = null;
  const status = document.getElementById('save-status');
  try {
    localStorage.setItem(STANDALONE_LS_KEY, JSON.stringify(buildBoardData()));
    if (status) { status.textContent = 'Saved'; status.style.color = '#2E7D32'; setTimeout(() => { status.textContent = ''; }, 2000); }
  } catch(e) {
    console.warn('localStorage save failed:', e);
    if (status) { status.textContent = 'Save failed'; status.style.color = '#C62828'; }
  }
}

function loadFromLocalStorage() {
  const raw = localStorage.getItem(STANDALONE_LS_KEY);
  if (raw) {
    try {
      const board = JSON.parse(raw);
      applyBoardData(board, 0);
      return true;
    } catch(e) { console.warn('Failed to parse standalone data:', e); }
  }
  // Empty board
  applyBoardData({ pillars: [], owners: [], columns: { now: [], next: [], waiting: [], done: [] } }, 0);
  return false;
}

function triggerImport() {
  document.getElementById('import-file-input').click();
}

function handleFileImport(input) {
  const file = input.files[0];
  if (!file) return;
  if (cards.length > 0 && !confirm('This will replace your current board. Continue?')) { input.value = ''; return; }
  // Back up current board before replacing
  try { localStorage.setItem(STANDALONE_LS_KEY + '-backup', JSON.stringify(buildBoardData())); } catch(e) {}
  const reader = new FileReader();
  reader.onload = function(e) {
    const board = parseBoardMd(e.target.result);
    applyBoardData(board, 0);
    renderOwnerPills(); renderAll();
    scheduleSave();
  };
  reader.onerror = function() { alert('Could not read the file.'); };
  reader.readAsText(file);
  input.value = '';
}

function exportBoardMd() {
  const md = serializeBoardMd(buildBoardData());
  const blob = new Blob([md], { type: 'text/markdown' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'Board.md';
  a.click();
  URL.revokeObjectURL(a.href);
}

function updateStandaloneUI() {
  document.querySelector('.hdr-subtitle').textContent = 'Standalone Mode';
  // Hide Settings button (vault config is meaningless without server)
  const settingsBtn = document.querySelector('.hdr-right .btn-secondary[onclick*="settings-modal"]');
  if (settingsBtn) settingsBtn.style.display = 'none';
  // Hide settings in mobile overflow menu
  const mobileSettingsBtn = document.querySelector('#mobile-overflow-menu button[onclick*="settings-modal"]');
  if (mobileSettingsBtn) mobileSettingsBtn.style.display = 'none';
  // Show import/export buttons
  document.querySelectorAll('.standalone-btn').forEach(el => el.style.display = '');
  document.querySelectorAll('.standalone-mobile-btn').forEach(el => el.style.display = '');
}

function applyBoardData(board, mtime) {
  lastMtime = mtime;
  // Assign IDs to pillars
  pillars = (board.pillars || []).map((p, i) => ({...p, id: 'p' + (i+1)}));
  nextPillarId = pillars.length + 1;
  // Assign IDs to owners
  owners = (board.owners || []).map((o, i) => ({...o, id: 'o' + (i+1)}));
  nextOwnerId = owners.length + 1;
  // Build reverse maps
  const ownerByName = Object.fromEntries(owners.map(o => [o.name, o.id]));
  const pillarByName = Object.fromEntries(pillars.map(p => [p.name, p.id]));
  // Flatten columns to cards
  cards = [];
  let cardId = 0;
  ['now','next','waiting','done'].forEach(col => {
    (board.columns[col] || []).forEach(c => {
      cards.push({
        id: ++cardId, title: c.title || '', note: c.note || '',
        fn: c.fn || '', ownerId: ownerByName[c.owner] || '',
        col, priority: c.priority || 'medium',
        link: c.link || '', pillarId: pillarByName[c.pillar] || '',
        due: c.due || '',
        nextAction: c.nextAction || '',
        movedAt: c.movedAt || new Date().toISOString().slice(0,10)
      });
    });
  });
  nextCardId = cardId + 1;
}

async function loadBoard() {
  try {
    const r = await fetch('/api/board', { signal: AbortSignal.timeout(3000) });
    const { board, mtime } = await r.json();
    applyBoardData(board, mtime);
    return true;
  } catch(e) {
    console.warn('Failed to load board:', e);
    return false;
  }
}

async function pollForChanges() {
  if (saving) return;
  // Don't reload while a modal or AI workspace is open
  if (document.querySelector('.modal-overlay.open')) return;
  if (document.getElementById('ai-workspace').classList.contains('open')) return;
  try {
    const r = await fetch('/api/board', { signal: AbortSignal.timeout(2000) });
    const { board, mtime } = await r.json();
    if (mtime !== lastMtime) {
      applyBoardData(board, mtime);
      renderOwnerPills(); renderAll();
    }
  } catch(e) {}
}

// ─────────────────────────────────────────
// SETTINGS
// ─────────────────────────────────────────
function setServerStatus(state, text) {
  const dot = document.getElementById('server-dot');
  const stxt = document.getElementById('server-status-text');
  if (!dot) return;
  const colors = { ok:'#2E7D32', error:'#C62828', off:'#D0D0CE' };
  dot.style.background = colors[state] || colors.off;
  if (stxt) stxt.textContent = text;
}

async function saveSettings() {
  const vault = document.getElementById('s-vault').value.trim();
  const boardFile = document.getElementById('s-board-file').value.trim();
  if (!vault) { document.getElementById('s-vault').focus(); return; }
  try {
    await fetch('/config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ vault_path: vault, board_file: boardFile || 'Meticulous/Board.md' })
    });
    document.getElementById('settings-modal').classList.remove('open');
    await loadBoard();
    renderOwnerPills(); renderAll();
  } catch(e) {
    alert('Could not save settings — is the server running?');
  }
}

async function loadSettingsModal() {
  try {
    const r = await fetch('/ping', { signal: AbortSignal.timeout(1500) });
    if (r.ok) {
      const data = await r.json();
      setServerStatus('ok', 'Connected — ' + data.board_file);
    }
  } catch(e) {
    setServerStatus('off', 'Server offline');
  }
  try {
    const r = await fetch('/config');
    const cfg = await r.json();
    document.getElementById('s-vault').value = cfg.vault || '';
    document.getElementById('s-board-file').value = cfg.board_file || 'Meticulous/Board.md';
  } catch(e) {}
}

// ─────────────────────────────────────────
// MIGRATION FROM LOCALSTORAGE
// ─────────────────────────────────────────
async function migrateFromLocalStorage() {
  const LS_KEY = 'meticulous-board-v1';
  const raw = localStorage.getItem(LS_KEY);
  if (!raw) return false;
  try {
    const data = JSON.parse(raw);
    if (!data.cards || data.cards.length === 0) return false;
    const ownerMap = {};
    (data.owners || []).forEach(o => { ownerMap[o.id] = o; });
    const pillarMap = {};
    (data.pillars || []).forEach(p => { pillarMap[p.id] = p; });
    const boardPillars = (data.pillars || []).map(p => ({icon:p.icon, name:p.name, color:p.color, desc:p.desc}));
    const boardOwners = (data.owners || []).map(o => ({name:o.name, initials:o.initials, color:o.color}));
    const columns = {now:[], next:[], waiting:[], done:[]};
    (data.cards || []).forEach(c => {
      const col = c.col || 'now';
      if (!columns[col]) columns[col] = [];
      columns[col].push({
        title: c.title, priority: c.priority || 'medium',
        owner: (ownerMap[c.ownerId] || {}).name || '',
        fn: c.fn || '', pillar: (pillarMap[c.pillarId] || {}).name || '',
        link: c.link || '', note: c.note || '',
        due: c.due || ''
      });
    });
    const boardData = { pillars: boardPillars, owners: boardOwners, columns };
    const r = await fetch('/api/board', {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(boardData)
    });
    if (r.ok) {
      localStorage.removeItem(LS_KEY);
      console.log('Migrated localStorage data to Board.md');
      return true;
    }
  } catch(e) { console.warn('Migration from localStorage failed:', e); }
  return false;
}

// ─────────────────────────────────────────
// MOBILE
// ─────────────────────────────────────────
const isMobile = () => window.matchMedia('(max-width:768px)').matches;
let mobileActivePane = 'board';
let longPressTimer = null;
let longPressCardId = null;
let touchMoved = false;

function mobileShowPane(pane) {
  mobileActivePane = pane;
  const pillars = document.getElementById('pane-pillars');
  const fns = document.getElementById('pane-functions');
  pillars.classList.remove('mobile-open');
  fns.classList.remove('mobile-open');
  document.querySelectorAll('.mobile-nav-btn').forEach(b => b.classList.remove('active'));
  if (pane === 'pillars') {
    pillars.classList.add('mobile-open');
    document.getElementById('mnav-pillars').classList.add('active');
  } else if (pane === 'functions') {
    fns.classList.add('mobile-open');
    document.getElementById('mnav-functions').classList.add('active');
  } else {
    document.getElementById('mnav-board').classList.add('active');
  }
}

function toggleMobileOverflow(e) {
  e.stopPropagation();
  const menu = document.getElementById('mobile-overflow-menu');
  menu.classList.toggle('open');
}
function closeMobileOverflow() {
  document.getElementById('mobile-overflow-menu').classList.remove('open');
}
document.addEventListener('click', function(e) {
  const menu = document.getElementById('mobile-overflow-menu');
  if (menu && !menu.contains(e.target) && !e.target.classList.contains('mobile-overflow-btn')) {
    menu.classList.remove('open');
  }
});

// Long-press for card action sheet
function onCardTouchStart(e, id) {
  touchMoved = false;
  longPressCardId = id;
  longPressTimer = setTimeout(function() {
    if (!touchMoved) openMobileActionSheet(id);
  }, 500);
}
function onCardTouchMove() {
  touchMoved = true;
  if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; }
}
function onCardTouchEnd() {
  if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; }
}

function openMobileActionSheet(id) {
  const c = cards.find(x => x.id === id);
  if (!c) return;
  longPressCardId = id;
  document.getElementById('action-sheet-title').textContent = c.title;
  // Highlight current column
  const sheet = document.getElementById('mobile-action-sheet');
  sheet.querySelectorAll('.mobile-action-sheet-section:first-of-type button').forEach(btn => {
    const col = btn.getAttribute('onclick').match(/'(\w+)'/);
    if (col && col[1] === c.col) btn.classList.add('active-col');
    else btn.classList.remove('active-col');
  });
  sheet.classList.add('open');
}
function closeMobileActionSheet() {
  document.getElementById('mobile-action-sheet').classList.remove('open');
  longPressCardId = null;
}
function mobileActionMove(col) {
  if (longPressCardId === null) return;
  const c = cards.find(x => x.id === longPressCardId);
  if (c && c.col !== col) {
    c.movedAt = new Date().toISOString().slice(0, 10);
    c.col = col;
    renderAll(); scheduleSave();
  }
  closeMobileActionSheet();
}
function mobileActionEdit() {
  const id = longPressCardId;
  closeMobileActionSheet();
  if (id !== null) openCardModal(id);
}

// Column scroll dots
function initMobileColumnDots() {
  if (!isMobile()) return;
  const board = document.getElementById('board');
  if (!board) return;
  // Remove existing dots
  const existing = document.querySelector('.mobile-col-dots');
  if (existing) existing.remove();
  const cols = board.querySelectorAll('.column');
  if (cols.length <= 1) return;
  const dotsDiv = document.createElement('div');
  dotsDiv.className = 'mobile-col-dots';
  cols.forEach((_, i) => {
    const dot = document.createElement('div');
    dot.className = 'mobile-col-dot' + (i === 0 ? ' active' : '');
    dotsDiv.appendChild(dot);
  });
  board.parentNode.insertBefore(dotsDiv, board);

  board.addEventListener('scroll', function() {
    const scrollLeft = board.scrollLeft;
    const colWidth = board.clientWidth;
    const activeIdx = Math.round(scrollLeft / colWidth);
    dotsDiv.querySelectorAll('.mobile-col-dot').forEach((d, i) => {
      d.classList.toggle('active', i === activeIdx);
    });
  }, { passive: true });
}

// ─────────────────────────────────────────
// INIT
// ─────────────────────────────────────────
document.getElementById('today-date').textContent =
  new Date().toLocaleDateString('en-CH',{weekday:'short',day:'numeric',month:'short',year:'numeric'});

(async function init() {
  // Restore persisted preferences
  document.getElementById('hide-done-cb').checked = hideDone;
  // Detect server availability
  let serverOk = false;
  try {
    const r = await fetch('/ping', { signal: AbortSignal.timeout(1500) });
    if (r.ok) {
      const ping = await r.json();
      aiAvailable = !!ping.hasApiKey;
      serverOk = true;
    }
  } catch(e) {}

  if (serverOk) {
    // ── SERVER MODE (unchanged) ──
    try {
      const cfg = await fetch('/config').then(r=>r.json());
      if (cfg.vault) { const parts = cfg.vault.replace(/\/+$/,'').split('/'); vaultName = parts[parts.length-1]; }
    } catch(e) {}
    await migrateFromLocalStorage();
    const loaded = await loadBoard();
    if (!loaded) console.warn('Could not load board from server.');
    renderOwnerPills();
    renderAll();
    setInterval(pollForChanges, 3000);
  } else {
    // ── STANDALONE MODE ──
    standaloneMode = true;
    aiAvailable = false;
    loadFromLocalStorage();
    renderOwnerPills();
    renderAll();
    updateStandaloneUI();
  }
})();

</script>
</body>
</html>
